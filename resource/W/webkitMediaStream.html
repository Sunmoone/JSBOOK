<div class="Content Detail">
					<div class="Content-top"><div class="ContentLeft"></div><div class="ContentRight"></div>
					<h1 class="ContentTitle"><strong>HTML5 MediaStream的运用</strong></h1>
					<h2 class="ContentAuthor">作者:puterjam 日期:2012-06-08</h2>
				</div>
			    <div class="Content-Info">
					<div class="InfoOther">字体大小: <a href="javascript:SetFont('12px')" accesskey="1">小</a> <a href="javascript:SetFont('14px')" accesskey="2">中</a> <a href="javascript:SetFont('16px')" accesskey="3">大</a></div>
					<div class="InfoAuthor"><img src="images/weather/hn2_sunny.gif" style="margin:0px 2px -6px 0px" alt=""><img src="images/weather/hn2_t_sunny.gif" alt=""> <img src="images/level3.gif" style="margin:0px 2px -1px 0px" alt="">
						<span class="ownerClassLog">
						<a href="blogedit.asp?id=1044" title="编辑该日志" accesskey="E"><img src="images/icon_edit.gif" alt="" border="0" style="margin-bottom:-2px"></a> <a href="blogedit.asp?action=del&amp;id=1044" onclick="if (!window.confirm('是否要删除该日志')) return false" accesskey="K"><img src="images/icon_del.gif" alt="" border="0" style="margin-bottom:-2px"></a>
						</span>
					</div>
				</div>
				<div id="logPanel" class="Content-body">
					<p style="text-align: center;"><img title="在新窗口打开图片" src="http://www.pjhome.net/attachments/month_1203/3201234183641.jpg" border="0" alt="Blog picture template artx 530x185 px" width="527" height="182" style="cursor: pointer;"></p>
<p>HTML5在技术上发展越来越快，在输入方面浏览器也开始具备了更多能力。舜子一直在关注视频和音频流在html5的支持，虽然不是什么创新点，但是对html来说是一个非常重要的能力。</p>
<p>Chrome 18开始就把<a href="http://www.w3.org/TR/streamproc/">MediaStream</a>放到实验室里，不过记得在19前的这些版本里，<a href="http://dev.w3.org/2011/webrtc/editor/getusermedia-20111222.html#navigatorusermedia">getUserMedia</a> 接口一直不太稳定，很容易crash。近期发现Chrome 19.0.1055 dev在这个接口的稳定性上有较好的提升。不过在稳定性上，还需要改善。例如，摄像头使用次数过多后，媒体流会莫名中断，对于没有安装摄像头的检测做得不够完善，可能会导致浏览器crash。不过相信chrome以后的版本会fix这些问题，也希望能在chrome 19 的release版本正式用上这个功能。</p>
<p>这个demo里，其实舜子很早就想用html5来完成gif视频合成的尝试了。也借这个机会，搞了一把极限开发，利用Chrome 的<a href="http://www.w3.org/TR/streamproc/">MediaStream</a>，把用户的摄像头作为动画合成的来源。</p>
<p><img title="在新窗口打开图片" src="http://www.pjhome.net/attachments/month_1203/1201234184516.jpg" border="0" alt="HTML5 GIF Maker 2" width="600" height="523" style="cursor: pointer;"></p>
<p>这里的关键技术并不复杂，在chrome下，我们可以使用navigator.webkitGetUserMedia即可，其他浏览器依次类推moz,o,ms之类。</p>
<blockquote>
<pre class="sunburst" style="margin-top: 0em; margin-right: 8px; margin-bottom: 8px; margin-left: 8px; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; font-size: 12px; line-height: 15px; color: #f8f8f8; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px;"><span class="source source_js source_js_embedded source_js_embedded_html" style="padding-top: 0.2em; padding-bottom: 0.1em;"><span style="color: #f8f8f8;"><pre class="sunburst" style="font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; margin: 0em 8px 8px; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; line-height: 15px; color: #f8f8f8;"><span class="meta meta_tag meta_tag_any meta_tag_any_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #89bdff;">&lt;<span class="entity entity_name entity_name_tag entity_name_tag_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #89bdff;">video</span> <span class="meta meta_attribute-with-value meta_attribute-with-value_id meta_attribute-with-value_id_html" style="padding-top: 0.2em; padding-bottom: 0.1em;"><span class="entity entity_other entity_other_attribute-name entity_other_attribute-name_id entity_other_attribute-name_id_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #89bdff;">id</span>=<span class="string string_quoted string_quoted_double string_quoted_double_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #65b042;">"<span class="meta meta_toc-list meta_toc-list_id meta_toc-list_id_html" style="padding-top: 0.2em; padding-bottom: 0.1em;">v</span>"</span></span> <span class="entity entity_other entity_other_attribute-name entity_other_attribute-name_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #89bdff;">autoplay</span>&gt;<span class="meta meta_scope meta_scope_between-tag-pair meta_scope_between-tag-pair_html" style="padding-top: 0.2em; padding-bottom: 0.1em;">&lt;</span>/<span class="entity entity_name entity_name_tag entity_name_tag_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #89bdff;">video</span>&gt;
</span><span style="color: #f8f8f8;"> </span><span class="source source_js source_js_embedded source_js_embedded_html" style="padding-top: 0.2em; padding-bottom: 0.1em;"><span style="color: #f8f8f8;">&lt;</span><span class="entity entity_name entity_name_tag entity_name_tag_script entity_name_tag_script_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #e0c589;">script</span><span style="color: #f8f8f8;">&gt;
</span><span class="support support_class support_class_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #9b859d;"><span style="color: #f8f8f8;">  </span></span><span class="support support_class support_class_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #9b859d;">navigator</span><span class="meta meta_delimiter meta_delimiter_method meta_delimiter_method_period meta_delimiter_method_period_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">.</span><span style="color: #f8f8f8;">webkitGetUserMedia</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">(</span><span class="string string_quoted string_quoted_single string_quoted_single_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #65b042;">{video:true}</span><span class="meta meta_delimiter meta_delimiter_object meta_delimiter_object_comma meta_delimiter_object_comma_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">,
</span><span class="storage storage_type storage_type_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #99cf50;">  function</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">(</span><span style="color: #f8f8f8;">stream</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">)</span><span class="meta meta_brace meta_brace_curly meta_brace_curly_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">{
</span><span style="color: #f8f8f8;">     </span><span class="support support_class support_class_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #9b859d;">document</span><span class="meta meta_delimiter meta_delimiter_method meta_delimiter_method_period meta_delimiter_method_period_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">.</span><span class="support support_function support_function_dom support_function_dom_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #dad085;">getElementById</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">(</span><span class="string string_quoted string_quoted_double string_quoted_double_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #65b042;">"v"</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">)</span><span class="meta meta_delimiter meta_delimiter_method meta_delimiter_method_period meta_delimiter_method_period_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">.</span><span class="support support_constant support_constant_dom support_constant_dom_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #cf6a4c;">src</span><span style="color: #f8f8f8;"> </span><span class="keyword keyword_operator keyword_operator_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #ce864b;">=</span><span style="color: #f8f8f8;"> webkitURL</span><span class="meta meta_delimiter meta_delimiter_method meta_delimiter_method_period meta_delimiter_method_period_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">.</span><span style="color: #f8f8f8;">createObjectURL</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">(</span><span style="color: #f8f8f8;">stream</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">)</span><span style="color: #f8f8f8;">;
 </span><span class="meta meta_brace meta_brace_curly meta_brace_curly_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">  }</span><span class="meta meta_delimiter meta_delimiter_object meta_delimiter_object_comma meta_delimiter_object_comma_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">,
  </span><span class="storage storage_type storage_type_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #99cf50;">function</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">(</span><span style="color: #f8f8f8;">error</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">)</span><span class="meta meta_brace meta_brace_curly meta_brace_curly_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">{
</span><span style="color: #f8f8f8;">     </span><span class="entity entity_name entity_name_type entity_name_type_object entity_name_type_object_js entity_name_type_object_js_firebug" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #89bdff;">console</span><span class="support support_function support_function_js support_function_js_firebug" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #dad085;">.log</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">(</span><span class="string string_quoted string_quoted_double string_quoted_double_js" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #65b042;">"不支持媒体流～ "</span><span class="meta meta_delimiter meta_delimiter_object meta_delimiter_object_comma meta_delimiter_object_comma_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">, </span><span style="color: #f8f8f8;">error</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">)</span><span style="color: #f8f8f8;">;
 </span><span class="meta meta_brace meta_brace_curly meta_brace_curly_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">  }</span><span class="meta meta_brace meta_brace_round meta_brace_round_js" style="padding-top: 0.2em; padding-bottom: 0.1em;">)</span><span style="color: #f8f8f8;">;
 &lt;/</span><span class="entity entity_name entity_name_tag entity_name_tag_script entity_name_tag_script_html" style="padding-top: 0.2em; padding-bottom: 0.1em; color: #e0c589;">script</span><span style="color: #f8f8f8;">&gt;&nbsp;</span></span></pre>
</span></span></pre>
</blockquote>
<p>这段代码正常情况下，你应该可以在浏览器里看到你的摄像头视频了。</p>
<p>&nbsp;</p>
<p>另外，舜子还想提到一个非常有用的东西就是URL对象。看到webkitURL了么？<a href="http://lists.w3.org/Archives/Public/public-webapps/2011OctDec/1499.html">createObjectURL</a> 是可以把一些<a href="https://developer.mozilla.org/en/Document_Object_Model_(DOM)/BlobBuilder">Blob(二进制大对象</a>)转换成一个本地的url，提供给script标签，img，video，audio，甚至file来使用，这样做有什么好处呢？</p>
<p>试想一下，浏览器未来直接在前端处理的资源会很多，你可以合成视频和音频，但是合成后的<a href="https://developer.mozilla.org/en/Document_Object_Model_(DOM)/BlobBuilder">Blob(二进制大对象</a>)如何给html来播放，那么这时候你就需要构造一个URI来提供，这个和base64URI还不一样。其实<a href="http://lists.w3.org/Archives/Public/public-webapps/2011OctDec/1499.html">createObjectURL</a>会更加强大。</p>
<p>你还可以把一些文本，直接转换成js，构造成一个url，提供给worker使用。减少了worker使用过程中需要多一个请求的开销。</p>
<blockquote>
<p>玩demo的，这边请：</p>
<p><a href="http://www.pjhome.net/web/gif_maker/">http://www.pjhome.net/web/gif_maker/</a></p>
<p><em>注意，最好是<a href="http://www.google.com/chrome/intl/en/eula_dev.html?dl=mac">chrome 19</a>以上的版本，并且确保你真的有摄像头（没摄像头可能会crash浏览器，chrome的bug）。</em></p>
</blockquote>
<blockquote>
<p>最后还得感谢，jsgif库。这个库是从as3版本转换过来的。</p>
<p><a href="https://github.com/antimatter15/jsgif">https://github.com/antimatter15/jsgif</a></p>
</blockquote>
					<br><br>
				</div>
				<div class="Content-body">
					<div class="Modify">[本日志由 puterjam 于 2012-06-08 04:11 PM 更新]</div>
                    <img border="0" src="images/Cprevious.gif" alt=""><strong>上一篇:</strong> <a href="article/Diary/1045.htm" accesskey=",">QQ闹钟 v2 for iPhone 发布</a><br><img border="0" src="images/Cnext.gif" alt=""><strong>下一篇:</strong> <a href="article/Diary/1046.htm" accesskey=".">给小米手机打包 Beats Audio 音效</a><br>
					<img src="images/From.gif" style="margin:0px 2px -4px 0px" alt=""><strong>文章来自:</strong> <a href="http://www.pjhome.net/" target="_blank">本站原创</a><br>
					<img src="images/icon_trackback.gif" style="margin:4px 2px -4px 0px" alt=""><strong>引用通告:</strong> <a href="trackback.asp?tbID=1044&amp;action=view" target="_blank">查看所有引用</a> | <a href="javascript:;" title="获得引用文章的链接" onclick="getTrackbackURL(1044)">我要引用此文章</a><br>
					<img src="images/tag.gif" style="margin:4px 2px -4px 0px" alt=""><strong>Tags:</strong> <a href="default.asp?tag=html5">html5</a><a href="http://technorati.com/tag/html5" rel="tag" style="display:none">html5</a> <a href="default.asp?tag=mediastream">mediastream</a><a href="http://technorati.com/tag/mediastream" rel="tag" style="display:none">mediastream</a> <a href="default.asp?tag=gif">gif</a><a href="http://technorati.com/tag/gif" rel="tag" style="display:none">gif</a> <br>
                    <img src="images/notify.gif" style="margin:4px 2px -4px 0px" alt=""><strong>相关日志:</strong>
                    <div class="Content-body" id="related_tag" style="margin-left:25px"><div style="margin-bottom:5px;"><strong>【您可能对以下 7 篇相关日志也感兴趣】</strong></div><li><span style="float:right;color:#aaa;margin:0px 25px 0px 0px">[2011-07-21]</span><a href="article/Javascript/html5_Orientation.html">HTML5 重力感应试玩～</a>[9811]</li><li><span style="float:right;color:#aaa;margin:0px 25px 0px 0px">[2011-04-21]</span><a href="article/Note/1035.html">微软出品 Html5 的吃豆人</a>[5933]</li><li><span style="float:right;color:#aaa;margin:0px 25px 0px 0px">[2011-01-19]</span><a href="article/Resource/html5_logo.html">给自己的站点打上HTML5的LOGO</a>[4031]</li><li><span style="float:right;color:#aaa;margin:0px 25px 0px 0px">[2010-09-27]</span><a href="article/Javascript/file_to_base64_url.html">利用HTML5对文件进行base64转换</a>[6176]</li><li><span style="float:right;color:#aaa;margin:0px 25px 0px 0px">[2010-02-22]</span><a href="article/Web/I_Can_t_Believe_It_s_Not_Flash.html">我不相信这不是Flash</a>[2743]</li><div class="page" style="margin-top:10px;"><ul><li class="pageNumber"><strong style="text-decoration:none" title="当前页">1</strong><a style="cursor:pointer" title="转到第2页" onclick="Related(1044, 2, 1, related_tag)">2</a><a style="cursor:pointer" onclick="Related(1044, 1, 2, related_tag)">全部显示</a></li></ul></div></div>
                    
				</div>
				<div class="Content-bottom"><div class="ContentBLeft"></div><div class="ContentBRight"></div>评论: 16 | <a href="trackback.asp?tbID=1044&amp;action=view" target="_blank">引用: 0</a> | 查看次数: <span id="countNum">9059</span> </div>
			</div>