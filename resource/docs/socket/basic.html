<article class="m_bloglst clearfix" id="post-900">
    <h1>
    	<a href="http://ued.sina.com.cn/?p=900" title="链向 WebSocket实战 的固定链接" rel="bookmark" target="_blank">WebSocket实战</a>
    </h1>                      
    <div class="m_entry">
        <img src="http://productdesign-wordpress.stor.sinaapp.com/WebSocket实战.jpg" title="WebSocket实战" alt="WebSocket实战">                   
						<h3>前言</h3>
<p>互联网发展到现在，早已超越了原始的初衷，人类从来没有像现在这样依赖过他；也正是这种依赖，促进了互联网技术的飞速发展。而终端设备的创新与发展，更加速了互联网的进化；
</p><p><span id="more-900"></span></p>
<p>HTTP/1.1规范发布于1999年，同年12月24日，HTML4.01规范发布；尽管已到2012年，但HTML4.01仍是主流；虽然HTML5的草案已出现了好几个年头，但转正日期，遥遥无期，少则三五年，多则数十年；而HTML5的客户代理(对于一般用户而言，就是浏览器)，则已百家争鸣，星星向荣；再加上移动终端的飞速发展，在大多数情况下，我们都可以保证拥有一个HTML5的运行环境，所以，我们来分享一下HTML5中的WebSocket协议；
</p><p>本文包含以下六个方面：<br>
1.	WebSocket的前世今生<br>
2.	WebSocket是什么<br>
3.	为什么使用WebSocket<br>
4.	搭建WebSocket服务器<br>
5.	WebSocket API<br>
6.	实例解析
</p>
<p>以上六点分为两大块，前3点侧重理论，主要让大家明白WebSocket是什么，而后3点则结合代码实战，加深对WebSocket的认知。</p>
<h3>一、WebSocket的前世今生</h3>
<p>Web 应用的信息交互过程通常是客户端通过浏览器发出一个请求，服务器端接收和审核完请求后进行处理并返回结果给客户端，然后客户端浏览器将信息呈现出来，这种机制对于信息变化不是特别频繁的应用尚能相安无事，但是对于那些实时要求比较高的应用来说就显得捉襟见肘了。我们需要一种高效节能的双向通信机制来保证数据的实时传输。有web TCP之称的WebSocket应运而生，给开发人员提供了一把强有力的武器来解决疑难杂症。<br>
(PS：其实，在早期的HTML5规范中，并没有包含WebSocket的定义，一些早期的HTML5书籍中，完全没有WebSocket的介绍。直到后来，才加入到当前的草案中。)</p>
<h3>二、WebSocket是什么？</h3>
<p>其实，从背景介绍中，我们大致的可以猜出，WebSocket是干什么用的。前面我们提到，WebSocket有web TCP之称，既然是TCP，肯定是用来做通信的，但是它又有不同的地方，WebSocket作为HTML5中新增的一种通信协议，由通信协议和编程API组成，它能够在浏览器和服务器之间建立双向连接，以基于事件的方式，赋予浏览器原生的实时通信能力，来扩展我们的web应用，增加用户体验，提升应用的性能。何谓双向？服务器端和客户端可以同时发送并响应请求，而不再像HTTP的请求和响应。</p>
<h3>三、为什么使用WebSocket</h3>
<p>在WebSocket出现之前，我们有一些其它的实时通讯方案，比较常用的有轮询，长轮询，流，还有基于Flash的交换数据的方式，接下来，我们一一分析一下，各种通信方式的特点。
</p>
<p><strong>①　轮询</strong><br>
这是最早的一种实现实时web应用的方案；原理比较简单易懂，就是客户端以一定的时间间隔向服务器发送请求，以频繁请求的方式来保持客户端和服务器端的数据同步。但是问题也很明显：当客户端以固定频率向服务器端发送请求时，服务器端的数据可能并没有更新，这样会带来很多无谓的请求，浪费带宽，效率低下。</p>
<p><strong>②　长轮询</strong><br>
长轮询是对定时轮询的改进和提高，目地是为了降低无效的网络传输。当服务器端没有数据更新的时候，连接会保持一段时间周期直到数据或状态改变或者时间过期，通过这种机制来减少无效的客户端和服务器间的交互。当然，如果服务端的数据变更非常频繁的话，这种机制和定时轮询比较起来没有本质上的性能的提高。</p>
<p><strong>③　流</strong><br>
长轮询是对定时轮询的改进和提高，目地是为了降低无效的网络传输。当服务器端没有数据更新的时候，连接会保持一段时间周期直到数据或状态改变或者时间过期，通过这种机制来减少无效的客户端和服务器间的交互。当然，如果服务端的数据变更非常频繁的话，这种机制和定时轮询比较起来没有本质上的性能的提高。</p>
<p><strong>④　基于Flash的实时通讯方式</strong><br>
Flash有自己的socket实现，这为实时通信提供了可能。我们可以利用Flash完成数据交换，再利用Flash暴露出相应的接口，方便JavaScript调用，来达到实时传输数据的目的。这种方式比前面三种方式都要高效，而且应用场景比较广泛；因为flash本身的安装率很高；但是在当前的互联网环境下，移动终端对flash的支持并不好，以IOS为主的系统中根本没有flash的存在，而在android阵营中，虽然有flash的支持，但实际的使用效果差强人意，即使是配置较高的移动设备，也很难让人满意。就在前几天(2012年6月底)，Adobe官方宣布，不在支持android4.1以后的系统，这基本上宣告了flash在移动终端上的死亡。</p>
<p>下面是轮询和长轮询的信息流转图：<br>
<img src="http://productdesign-wordpress.stor.sinaapp.com/2012_07_06_10_101.gif"><br>
<img src="http://productdesign-wordpress.stor.sinaapp.com/2012_07_06_10_102.gif">
</p>
<p>对比完四种不同的实时通信方式，不难发现，除了基于flash的方案外，其它三种方式都是用AJAX方式来模拟实时的效果，每次客户端和服务器端交互时，都是一次完整的HTTP请求和应答的过程，而每一次的HTTP请求和应答都带有完整的HTTP头信息，这就增加每次的数据传输量，而且这些方案中客户端和服务端的编程实现比较复杂。</p>
<p>接下来，我们再来看一下WebSocket，为什么要使用它呢？高效节能，简单易用。<br>
下图是来自websocket.org的测试结果：<br>
<img src="http://productdesign-wordpress.stor.sinaapp.com/2012_07_06_10_103.gif">
</p>
<p>在流量和负载增大的情况下，WebSocket 方案相比传统的 Ajax 轮询方案有极大的性能优势；而在开发方面，也十分简单，我们只需要实例化WebSocket，创建连接，查看是否连接成功，然后就可以发送和相应消息了。我们会在后面的实例中去详细的说明API。</p>
