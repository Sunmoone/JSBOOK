<div id="article_details" class="details">
    <div class="article_title">
    <span class="ico ico_type_Original"></span>
    <h1>
        <span class="link_title"><a href="/hfahe/article/details/7421203">
        遇见Javascript类型数组(Typed Array)
        </a></span>
    </h1>
</div>

    
    
</div>   
<div id="article_content" class="article_content">
<p><span style="color:#333333;">&nbsp; &nbsp; &nbsp; &nbsp; 我在</span><span style="color:#333333;">Chrome</span><span style="color:#333333;">的</span><u><span style="color:#0070C0;"><a target="_blank" href="http://blog.csdn.net/hfahe/article/details/7408426"><span style="color:#0070C0;">最新动态</span></a></span></u><span style="color:#333333;">里提到了</span><span style="color:#333333;">Typed Arrays</span><span style="color:#333333;">（Typed Array，类型数组）这个概念，可能对很多人来说非常陌生，那么它是什么，又有什么用途呢？</span></p><p><strong><span style="color:#333333;">之前的问题</span></strong></p><p><span style="color:#333333;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>Web</span><span style="color:#333333;">应用程序变得越来越强大，例如新增了音视频处理、</span><span style="color:#333333;">WebSocket</span><span style="color:#333333;">等多个功能特性。毫无疑问，如果</span><span style="color:#333333;">Javascript</span><span style="color:#333333;">能够快速方便的操作原始二进制数据会相当的有用。过去，我们必须要把原始数据当作字符串来处理，并且使用</span><span style="color:#333333;">charCodeAt</span><span style="color:#333333;">方法来从数据缓冲区中读取字节。</span></p><p><span style="color:#333333;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>但是这种方法需要多次转换数据（尤其在二进制数据不是字节格式的数据时，例如</span><span style="color:#333333;">32</span><span style="color:#333333;">位整数或者浮点数），所以非常慢而且容易出错。</span></p><p><span style="color:#333333;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>Javascript</span><span style="color:#333333;">需要一种机制来更有效的访问原始的二进制数据，由此产生了类型数组。</span></p><p><strong><span style="color:#333333;">定义</span></strong></p><p><span style="color:#333333;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>其实除了</span><span style="color:#333333;">Javascript</span><span style="color:#333333;">，类型数组在其他很多语言中也有。它是一种数组，只有一种变量的类型。例如，一个</span><span style="color:#333333;">float</span><span style="color:#333333;">类型的数组将只包含浮点数而不能混用字符串和浮点数。此外，一个类型数组在初始化后不能改变大小。它看起来形式和普通</span><span style="color:#333333;">Javascript</span><span style="color:#333333;">数组很像，但是数据格式是一致和同一类型的（例如声音或者像素点的缓冲数据）。</span></p><p><span style="color:#333333;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>类型数组的规范参见</span><a target="_blank" href="http://www.khronos.org/registry/typedarray/specs/latest/">这里</a><span style="color:#333333;">。这个规范实质上定义了一种</span><span style="color:#333333;">arrayBuffer</span><span style="color:#333333;">类型，相当于一个普通的定长二进制缓冲区。我们不能直接访问和操作</span><span style="color:#333333;">arrayBuffer</span><span style="color:#333333;">的内容，而需要类型数组来创建</span><span style="color:#333333;">arrayBuffer</span><span style="color:#333333;">的视图（从技术上来说，类型数组等同于</span><span style="color:#333333;">arrayBuffer</span><span style="color:#333333;">，因为它们本质上是一样的）。例如，要访问</span><span style="color:#333333;">32</span><span style="color:#333333;">位有符号整数数组作为缓冲区，会创建一个</span><span style="color:#333333;">Int32Array</span><span style="color:#333333;">的类型数组来指向</span><span style="color:#333333;">arrayBuffer</span><span style="color:#333333;">。</span></p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>多个类型数组视图可以指向同一个<span style="color:#333333;">arrayBuffer</span>，采用不同的类型、不同的长度以及不同的位移。例如下面的代码：</p><p></p><div class="dp-highlighter bg_html"><div class="bar"><div class="tools"><b>[html]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><div style="position: absolute; left: 592px; top: 1065px; width: 18px; height: 18px; z-index: 99;"><embed id="ZeroClipboardMovie_1" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="18" height="18" name="ZeroClipboardMovie_1" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=1&amp;width=18&amp;height=18" wmode="transparent"></div></div></div><ol start="1" class="dp-xml"><li class="alt"><span><span>//&nbsp;创建一个8字节的ArrayBuffer&nbsp;&nbsp;</span></span></li><li class=""><span>var&nbsp;<span class="attribute">b</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">new</span><span>&nbsp;ArrayBuffer(8);&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>//&nbsp;创建一个指向b的视图v1，采用Int32类型，开始于默认的字节索引0，直到缓冲区的末尾&nbsp;&nbsp;</span></li><li class="alt"><span>var&nbsp;<span class="attribute">v1</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">new</span><span>&nbsp;Int32Array(b);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>//&nbsp;创建一个指向b的视图v2，采用Uint8类型，开始于字节索引2，直到缓冲区的末尾&nbsp;&nbsp;</span></li><li class=""><span>var&nbsp;<span class="attribute">v2</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">new</span><span>&nbsp;Uint8Array(b,&nbsp;2);&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>//&nbsp;创建一个指向b的视图v3，采用Int16类型，开始于字节索引2，长度为2&nbsp;&nbsp;</span></li><li class="alt"><span>var&nbsp;<span class="attribute">v3</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">new</span><span>&nbsp;Int16Array(b,&nbsp;2,&nbsp;2);&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="html" style="display: none;">      // 创建一个8字节的ArrayBuffer
      var b = new ArrayBuffer(8);

      // 创建一个指向b的视图v1，采用Int32类型，开始于默认的字节索引0，直到缓冲区的末尾
      var v1 = new Int32Array(b);

      // 创建一个指向b的视图v2，采用Uint8类型，开始于字节索引2，直到缓冲区的末尾
      var v2 = new Uint8Array(b, 2);

      // 创建一个指向b的视图v3，采用Int16类型，开始于字节索引2，长度为2
      var v3 = new Int16Array(b, 2, 2);</pre><p></p><p><span style="color:#006600;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span>上述代码里变量的数据结构如下所示。</p><p align="center"><img src="http://namepk.sinaapp.com/blog/typedarray/1.jpg" alt=""><br></p><p align="center">变量的数据结构</p><p><span style="color:#006600;"><span style="color: rgb(51, 51, 51); "><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span></span>类型数组包括以下几种类型：</p><div align="center"><table border="1" cellspacing="0" cellpadding="0"> <tbody><tr>  <td valign="top" style="background:#4F81BD;"><p align="left"><strong>名称</strong></p></td>  <td valign="top" style="background:#4F81BD;"><p align="left"><strong>大小 (以字节为单位)</strong></p></td>  <td valign="top" style="background:#4F81BD;"><p align="left"><strong>说明</strong></p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Int8Array</strong></p></td>  <td valign="top"><p align="left">1</p></td>  <td valign="top"><p align="left">8位有符号整数</p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Uint8Array</strong></p></td>  <td valign="top"><p align="left">1</p></td>  <td valign="top"><p align="left">8位无符号整数</p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Int16Array</strong></p></td>  <td valign="top"><p align="left">2</p></td>  <td valign="top"><p align="left">16位有符号整数</p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Uint16Array</strong></p></td>  <td valign="top"><p align="left">2</p></td>  <td valign="top"><p align="left">16位无符号整数</p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Int32Array</strong></p></td>  <td valign="top"><p align="left">4</p></td>  <td valign="top"><p align="left">32位有符号整数</p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Uint32Array</strong></p></td>  <td valign="top"><p align="left">4</p></td>  <td valign="top"><p align="left">32位无符号整数</p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Float32Array</strong></p></td>  <td valign="top"><p align="left">4</p></td>  <td valign="top"><p align="left">32位浮点数</p></td> </tr> <tr>  <td valign="top"><p align="left"><strong>Float64Array</strong></p></td>  <td valign="top"><p align="left">8</p></td>  <td valign="top"><p align="left">64位浮点数</p></td> </tr></tbody></table></div><p>&nbsp;</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>类型数组实际上目前是作为WebGL的一部分来实现的（和它相关的还有File API），但是它可以用在任何地方。</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>下面我们来谈谈类型数组的优点和用途。</p><p><strong><span style="color:#333333;">优点</span></strong></p><p>1、&nbsp; 性能优秀</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>所有类型数组相关的文档都提到的重要一点是，类型数组比传统数组快的多，具有非常好的性能。因为类型数组实际上是作为一个固定的内存块来进行访问的，而传统的普通Javascript数组使用的是Hash查找方式（因为元素长度不定）。</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>这里有一个简单的测试结果，在Firefox4 Beta1版本，我们对比了一个普通数组和Float32Array数组在操作1亿个元素时每种操作所花费的时间。这个测试运行在Win7 64位、4G内存和Intel双核1.3G CPU的平台上。我们运行这个测试8次并使用其中最慢的一个时间。需要指出的是，普通Javascript数组的写入操作经常花费超过10秒钟，这会导致出现运行缓慢的脚本对话框。</p><div align="center"><table border="1" cellspacing="0" cellpadding="0"> <tbody><tr>  <td valign="top" style="background:#4F81BD;"><p><strong><span style="color:white;">操作</span></strong></p></td>  <td valign="top" style="background:#4F81BD;"><p><strong><span style="color:white;">普通数组</span></strong></p></td>  <td valign="top" style="background:#4F81BD;"><p><strong><span style="color:white;">Float32Array</span></strong></p></td> </tr> <tr>  <td valign="top"><p><strong>写</strong></p></td>  <td valign="top"><p>8947</p></td>  <td valign="top"><p>1455</p></td> </tr> <tr>  <td valign="top"><p><strong>读</strong></p></td>  <td valign="top"><p>1948</p></td>  <td valign="top"><p>1109</p></td> </tr> <tr>  <td valign="top"><p><strong>循环复制</strong></p></td>  <td valign="top"><p>&gt;10,000</p></td>  <td valign="top"><p>1969</p></td> </tr> <tr>  <td valign="top"><p><strong>片段复制</strong></p></td>  <td valign="top"><p>1125</p></td>  <td valign="top"><p>503</p></td> </tr></tbody></table></div><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>下面我们有一个关于普通数组、类型数组（arrayBuffer）以及imageData之间性能的比较，可以看到arrayBuffer会快得多。</p><p style="text-align: center;"><img src="http://namepk.sinaapp.com/blog/typedarray/2.jpg" width="424" height="264" alt=""><br></p><p> </p><p align="center">性能优异的arrayBuffer</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>其实在类型数组之前，Javascript也支持二进制字节的数组，这就是imageData。imageData是Canvas元素2D上下文环境里定义的数据类型。当在Canvas 2D里调用getImageData或者createImageData方法时就创建了imageData。imageData的data属性是一个字节数组，它实际大小是图片宽*高的四倍（因为每个像素有R、G、B、A四个通道）。之前我们在《<a target="_blank" href="http://blog.csdn.net/hfahe/article/details/6208765">用HTML5创建超酷图像灰度渐变效果</a>》这篇文章里就用到了imageData。</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>从图表数据来看，imageData和arrayBuffer在多个浏览器里创建的性能远远高于普通的数组（<a target="_blank" href="http://blog.n01se.net/?p=248">数据来源</a>）。不过这里有一个问题，后面将会提到。</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>可以想见，因为优秀的性能表现，<span style="color: rgb(192, 0, 0); ">类型数组可以广泛的应用于</span><span style="color:#C00000;">Javascript</span><span style="color:#C00000;">图像以及视频的处理和压缩，还有一些需要复杂运算的场景例如</span><span style="color:#C00000;">MD5</span><span style="color:#C00000;">计算中</span>，让功能可以更快速更高效的完成。例如我们先把imageData转换为类型数组以换取更快的执行速度，如下面的代码：</p><pre style="background:white;"><span style="color:#9a6f1b;"></span><div class="dp-highlighter bg_html"><div class="bar"><div class="tools"><b>[html]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><div style="position: absolute; left: 592px; top: 3571px; width: 18px; height: 18px; z-index: 99;"><embed id="ZeroClipboardMovie_2" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="18" height="18" name="ZeroClipboardMovie_2" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=2&amp;width=18&amp;height=18" wmode="transparent"></div></div></div><ol start="1" class="dp-xml"><li class="alt"><span><span>var&nbsp;</span><span class="attribute">canvas</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">document</span><span>.getElementById('canvas');&nbsp;&nbsp;</span></span></li><li class=""><span>var&nbsp;<span class="attribute">canvasWidth</span><span>&nbsp;&nbsp;=&nbsp;</span><span class="attribute-value">canvas</span><span>.width;&nbsp;&nbsp;</span></span></li><li class="alt"><span>var&nbsp;<span class="attribute">canvasHeight</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">canvas</span><span>.height;&nbsp;&nbsp;</span></span></li><li class=""><span>var&nbsp;<span class="attribute">ctx</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">canvas</span><span>.getContext('2d');&nbsp;&nbsp;</span></span></li><li class="alt"><span>var&nbsp;<span class="attribute">imageData</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">ctx</span><span>.getImageData(0,0,&nbsp;canvasWidth,&nbsp;canvasHeight);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>var&nbsp;<span class="attribute">buf</span><span>&nbsp;=</span><span class="attribute-value">new</span><span>&nbsp;ArrayBuffer(imageData.data.length);&nbsp;&nbsp;</span></span></li><li class=""><span>var&nbsp;<span class="attribute">data</span><span>&nbsp;=</span><span class="attribute-value">new</span><span>&nbsp;Uint32Array(buf);&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>for(var&nbsp;<span class="attribute">y</span><span>&nbsp;=</span><span class="attribute-value">0</span><span>;&nbsp;y&nbsp;</span><span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">canvasHeight</span><span>;++y){&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;for(var&nbsp;<span class="attribute">x</span><span>&nbsp;=</span><span class="attribute-value">0</span><span>;&nbsp;x&nbsp;</span><span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">canvasWidth</span><span>;++x){&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">value</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">x</span><span>&nbsp;*&nbsp;y&nbsp;&amp;0xff;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data[y&nbsp;*&nbsp;canvasWidth&nbsp;+&nbsp;x]=&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(255&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag">&lt;</span><span class="tag-name">24</span><span>)|&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;alpha&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(value&nbsp;<span class="tag">&lt;</span><span class="tag">&lt;</span><span class="tag-name">16</span><span>)|&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;blue&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(value&nbsp;<span class="tag">&lt;</span><span class="tag">&lt;</span><span>&nbsp;&nbsp;</span><span class="tag-name">8</span><span>)|&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;green&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;red&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=""><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="html" style="display: none;">var canvas = document.getElementById('canvas');
var canvasWidth  = canvas.width;
var canvasHeight = canvas.height;
var ctx = canvas.getContext('2d');
var imageData = ctx.getImageData(0,0, canvasWidth, canvasHeight);
 
var buf =new ArrayBuffer(imageData.data.length);
var data =new Uint32Array(buf);
 
for(var y =0; y &lt; canvasHeight;++y){
    for(var x =0; x &lt; canvasWidth;++x){
        var value = x * y &amp;0xff;
 
        data[y * canvasWidth + x]=
            (255   &lt;&lt;24)|    // alpha
            (value &lt;&lt;16)|    // blue
            (value &lt;&lt;  8)|    // green
             value;            // red
    }
}</pre></pre><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>另外一方面，<span style="color:#C00000;">因为类型数组可以显著增加</span><span style="color:#C00000;">HTML5 Canvas 2D Web App</span><span style="color:#C00000;">的性能，所以这一特性对于使用</span><span style="color:#C00000;">HTML5</span><span style="color:#C00000;">来创建</span><span style="color:#C00000;">Web</span><span style="color:#C00000;">游戏的开发者会非常重要</span>。</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>下面是两个使用类型数组的示例。</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>第一个是Energy2D的<a target="_blank" href="http://visual-demos.dev.concord.org/seasons/earth/model2d.html">演示</a>，用于对比普通数组和类型数组的性能，大家可以自行体验。</p><p style="text-align: center;"><img src="http://namepk.sinaapp.com/blog/typedarray/3.jpg" alt=""><br></p><p align="center"> </p><p align="center">Energy2D演示</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>第二个示例是使用类型数组、FileAPI以及Web Workers实现的SHA1<a target="_blank" href="http://antimatter15.github.com/js-typed-array-sha1/">在线计算器</a>，它的性能相当出色。正是在类型数组的支持下，Javascript执行SHA1、MD5这样复杂运算的速度变得越来越快。</p><p align="center"><img src="http://namepk.sinaapp.com/blog/typedarray/4.jpg" alt=""> </p><p align="center">类型数组支持的在线SHA1计算器</p><p>&nbsp;</p><p>2、&nbsp; 二进制支持</p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>上文曾经提到类型数组最主要的特点是支持二进制数据。的确，现在HTMl5的许多API涉及音视频和实时通信，这些功能经常依赖于二进制文件格式，例如MP3音频、MP4视频和PNG图像。二进制格式对于减少带宽，提高性能，以及与现有文件格式互相转换来说非常重要。</p><p><span style="color:#C00000;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>类型数组使得</span><span style="color:#C00000;">Web</span><span style="color:#C00000;">应用可以使用多种二进制文件格式和直接操作文件的二进制内容，例如从现有的媒体文件中提取数据</span>。</p><p><span style="color:#333333;background:white;"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></span><span style="color:#333333;background:white;">在</span><span style="color:#333333;background:white;">IE10</span><span style="color:#333333;background:white;">上，已经提供了类型数组的支持（支持WebGL其实是微软非常纠结的事情）。我们可以看看微软所提供的二进制文件检测器的</span><a target="_blank" href="http://ie.microsoft.com/testdrive/HTML5/TypedArrays/"><span style="background:white;">例子</span></a><span style="color:#333333;background:white;">：</span></p><p align="center"><img src="http://namepk.sinaapp.com/blog/typedarray/7.jpg" alt=""><br></p><p align="left"><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>在这个示例里，我们可以获取音乐文件的ID3头，视频文件的原始字节数据，以及附加文件的格式。它的核心代码如下：</p><p style="background:white;"></p><div class="dp-highlighter bg_html"><div class="bar"><div class="tools"><b>[html]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><div style="position: absolute; left: 592px; top: 5717px; width: 18px; height: 18px; z-index: 99;"><embed id="ZeroClipboardMovie_3" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="18" height="18" name="ZeroClipboardMovie_3" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=3&amp;width=18&amp;height=18" wmode="transparent"></div></div></div><ol start="1" class="dp-xml"><li class="alt"><span><span>function&nbsp;getHexChunk(buffer,&nbsp;startAt)&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">chunkLength</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">Math</span><span>.min(CHUNK_SIZE,&nbsp;buffer.byteLength&nbsp;-&nbsp;startAt)&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">uints</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">new</span><span>&nbsp;Uint8Array(buffer,&nbsp;startAt,&nbsp;chunkLength);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">rowString</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">""</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(var&nbsp;<span class="attribute">row</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">0</span><span>;&nbsp;row&nbsp;</span><span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">uints.length</span><span>;&nbsp;row&nbsp;+=&nbsp;16)&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">remaining</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">uints</span><span>.length&nbsp;-&nbsp;row;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowString&nbsp;+=&nbsp;intToHexString(row&nbsp;+&nbsp;startAt,&nbsp;8);&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowString&nbsp;+=&nbsp;"&nbsp;&nbsp;";&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(var&nbsp;<span class="attribute">offset</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">0</span><span>;&nbsp;offset&nbsp;</span><span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">8</span><span>&nbsp;;&nbsp;offset++)&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(offset&nbsp;<span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">remaining</span><span>)&nbsp;rowString&nbsp;+=&nbsp;intToHexString(uints[row&nbsp;+&nbsp;offset],&nbsp;2)&nbsp;+&nbsp;"&nbsp;";&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;rowString&nbsp;+=&nbsp;"&nbsp;&nbsp;";&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowString&nbsp;+=&nbsp;"&nbsp;";&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(;&nbsp;offset&nbsp;<span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">16</span><span>;&nbsp;offset++)&nbsp;{&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(offset&nbsp;<span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">remaining</span><span>)&nbsp;rowString&nbsp;+=&nbsp;intToHexString(uints[row&nbsp;+&nbsp;offset],&nbsp;2)&nbsp;+&nbsp;"&nbsp;";&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;rowString&nbsp;+=&nbsp;"&nbsp;&nbsp;";&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowString&nbsp;+=&nbsp;"&nbsp;&nbsp;";&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(var&nbsp;<span class="attribute">offset</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">0</span><span>;&nbsp;offset&nbsp;</span><span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">8</span><span>;&nbsp;offset++)&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowString&nbsp;+=&nbsp;charForInt(uints[row&nbsp;+&nbsp;offset]);&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(;&nbsp;offset&nbsp;<span class="tag">&lt;</span><span>&nbsp;</span><span class="tag-name">16</span><span>;&nbsp;offset++)&nbsp;{&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowString&nbsp;+=&nbsp;charForInt(uints[row&nbsp;+&nbsp;offset]);&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowString&nbsp;+=&nbsp;"\n";&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;rowString;&nbsp;&nbsp;</span></li><li class=""><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="html" style="display: none;">function getHexChunk(buffer, startAt) {
    var chunkLength = Math.min(CHUNK_SIZE, buffer.byteLength - startAt)
    var uints = new Uint8Array(buffer, startAt, chunkLength);
    var rowString = "";
    for (var row = 0; row &lt; uints.length; row += 16) {
        var remaining = uints.length - row;
        rowString += intToHexString(row + startAt, 8);
        rowString += "  ";
        for (var offset = 0; offset &lt; 8 ; offset++) {
            if (offset &lt; remaining) rowString += intToHexString(uints[row + offset], 2) + " ";
            else rowString += "  ";
        }
        rowString += " ";
        for (; offset &lt; 16; offset++) {
            if (offset &lt; remaining) rowString += intToHexString(uints[row + offset], 2) + " ";
            else rowString += "  ";
        }
        rowString += "  ";
        for (var offset = 0; offset &lt; 8; offset++) {
            rowString += charForInt(uints[row + offset]);
        }
        for (; offset &lt; 16; offset++) {
            rowString += charForInt(uints[row + offset]);
        }
        rowString += "\n";
    }
    return rowString;
}</pre><p></p><p><span style="color: rgb(51, 51, 51); text-align: -webkit-left; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>页面上文件的二进制格式输出就是用这段代码实现的。</p><p><strong><span style="color:#333333;">具体应用</span></strong></p><p><a target="_blank" href="http://blog.digitalbackcountry.com/2012/01/dealing-with-binary-data-from-a-canvas-object-using-javascript-typedarrays/"><span style="color: rgb(51, 51, 51); text-align: -webkit-left; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>这里</a>有一个使用类型数组在Canvas图像和二进制数据之间互相转换，然后通过WebSocket发送的示例。作者提到“在我实现二进制WebSocket示例时，我学习了很多Javascript类型数组的知识，了解了如何把对象转换为二进制数据。我写了一个示例来获取Canvas图像数据，并且把它通过二进制的WebSocket连接发送出去。WebSocket服务器获取图像数据，然后把它发送给所有连接的客户端（宇捷：<span style="color:#C00000;">这让我想起了最近国外非常火爆的超人气应用</span><a target="_blank" href="http://game.163.com/12/0322/17/7T7G2FL200314OSE.html"><span style="color:#C00000;background:white;">DrawSomething-</span><span style="color:#C00000;background:white;">你画我猜</span></a><span style="color:#C00000;background:white;">，我们可以用这种方式实现类似的</span><span style="color:#C00000;background:white;">WebApp</span>），然后客户端再把Canvas数据还原为PNG图片。采用这种方式发送图像数据比起base64编码来更有效率（数据小33%，而且更利于序列化和存储）。”</p><p style="text-align: center;"><img src="http://namepk.sinaapp.com/blog/typedarray/5.jpg" alt=""> </p><p align="center">创造了历史的应用-你画我猜</p><p><span style="color: rgb(51, 51, 51); text-align: -webkit-left; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>WebSocket支持二进制数据传输，对于WebSocket服务器来说，使用二进制数据会比UTF-8更为简单，不过现在浏览器支持方面还有问题。</p><p><span style="color: rgb(51, 51, 51); text-align: -webkit-left; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>示例里实现将Canvas数据转换为二进制格式的代码如下：</p><p></p><div class="dp-highlighter bg_html"><div class="bar"><div class="tools"><b>[html]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><div style="position: absolute; left: 592px; top: 7066px; width: 18px; height: 18px; z-index: 99;"><embed id="ZeroClipboardMovie_4" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="18" height="18" name="ZeroClipboardMovie_4" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=4&amp;width=18&amp;height=18" wmode="transparent"></div></div></div><ol start="1" class="dp-xml"><li class="alt"><span><span class="attribute">imagedata</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">context</span><span>.getImageData(0,&nbsp;0,&nbsp;imagewidth,imageheight);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>var&nbsp;<span class="attribute">canvaspixelarray</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">imagedata</span><span>.data;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>var&nbsp;<span class="attribute">canvaspixellen</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">canvaspixelarray</span><span>.length;&nbsp;&nbsp;</span></span></li><li class="alt"><span>var&nbsp;<span class="attribute">bytearray</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">new</span><span>&nbsp;Uint8Array(canvaspixellen);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>for&nbsp;(var&nbsp;<span class="attribute">i</span><span>=</span><span class="attribute-value">0</span><span>;i</span><span class="tag">&lt;</span><span class="tag-name">canvaspixellen</span><span>;++i)&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytearray[i]&nbsp;=&nbsp;canvaspixelarray[i];&nbsp;&nbsp;</span></li><li class="alt"><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="html" style="display: none;">     imagedata = context.getImageData(0, 0, imagewidth,imageheight);
 
     var canvaspixelarray = imagedata.data;
 
 
     var canvaspixellen = canvaspixelarray.length;
     var bytearray = new Uint8Array(canvaspixellen);
 
     for (var i=0;i&lt;canvaspixellen;++i) {
          bytearray[i] = canvaspixelarray[i];
     }</pre><p></p><p><span style="color: rgb(51, 51, 51); text-align: -webkit-left; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>而把二进制数据还原为图像的代码如下，请注意我们不能直接从arrayBuffer获取数据直接放到Canvas中。</p><p></p><div class="dp-highlighter bg_html"><div class="bar"><div class="tools"><b>[html]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><div style="position: absolute; left: 592px; top: 7359px; width: 18px; height: 18px; z-index: 99;"><embed id="ZeroClipboardMovie_5" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="18" height="18" name="ZeroClipboardMovie_5" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=5&amp;width=18&amp;height=18" wmode="transparent"></div></div></div><ol start="1" class="dp-xml"><li class="alt"><span><span>var&nbsp;</span><span class="attribute">bytearray</span><span>&nbsp;=</span><span class="attribute-value">new</span><span>&nbsp;Uint8Array(event.data);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>var&nbsp;<span class="attribute">tempcanvas</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">document</span><span>.createElement('canvas');&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">tempcanvas.height</span><span>=&nbsp;</span><span class="attribute-value">imageheight</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">tempcanvas.width</span><span>=&nbsp;</span><span class="attribute-value">imagewidth</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>var&nbsp;<span class="attribute">tempcontext</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">tempcanvas</span><span>.getContext('2d');&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>var&nbsp;<span class="attribute">imgdata</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">tempcontext</span><span>.getImageData(0,0,imagewidth,imageheight);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>var&nbsp;<span class="attribute">imgdatalen</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">imgdata</span><span>.data.length;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>for(var&nbsp;<span class="attribute">i</span><span>=</span><span class="attribute-value">8</span><span>;i</span><span class="tag">&lt;</span><span class="tag-name">imgdatalen</span><span>;i++)&nbsp;&nbsp;</span></span></li><li class=""><span>{&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;imgdata.data[i]=&nbsp;bytearray[i];&nbsp;&nbsp;</span></li><li class=""><span>}&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>tempcontext.putImageData(imgdata,0,0);&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="html" style="display: none;">var bytearray =new Uint8Array(event.data);
 
 
var tempcanvas = document.createElement('canvas');
    tempcanvas.height= imageheight;
    tempcanvas.width= imagewidth;
var tempcontext = tempcanvas.getContext('2d');
 
var imgdata = tempcontext.getImageData(0,0,imagewidth,imageheight);
 
var imgdatalen = imgdata.data.length;
 
for(var i=8;i&lt;imgdatalen;i++)
{
    imgdata.data[i]= bytearray[i];
}

tempcontext.putImageData(imgdata,0,0);</pre><p></p><p><span style="color: rgb(51, 51, 51); text-align: -webkit-left; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>在Adobe的官网上，也有一个类似的<a target="_blank" href="http://www.adobe.com/devnet/html5/articles/real-time-data-exchange-in-html5-with-websockets.html">完整示例</a>：《Real Time Data Exchange in HTML5 with WebSocket》。可以看到里面利用类型数组发送图片的代码如下：</p><p></p><div class="dp-highlighter bg_html"><div class="bar"><div class="tools"><b>[html]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><div style="position: absolute; left: 592px; top: 7804px; width: 18px; height: 18px; z-index: 99;"><embed id="ZeroClipboardMovie_6" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="18" height="18" name="ZeroClipboardMovie_6" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=6&amp;width=18&amp;height=18" wmode="transparent"></div></div></div><ol start="1" class="dp-xml"><li class="alt"><span><span>function&nbsp;sendphoto()&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">imagedata</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">context</span><span>.getImageData(0,&nbsp;0,&nbsp;imagewidth,imageheight);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">canvaspixelarray</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">imagedata</span><span>.data;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">canvaspixellen</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">canvaspixelarray</span><span>.length;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;<span class="attribute">bytearray</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">new</span><span>&nbsp;Uint8Array(canvaspixellen);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(var&nbsp;<span class="attribute">i</span><span>=</span><span class="attribute-value">0</span><span>;i</span><span class="tag">&lt;</span><span class="tag-name">canvaspixellen</span><span>;++i)&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytearray[i]&nbsp;=&nbsp;canvaspixelarray[i];&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;connection.send(bytearray.buffer);&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">context.fillStyle</span><span>&nbsp;=&nbsp;</span><span class="attribute-value">'#ffffff'</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;context.fillRect(0,&nbsp;0,&nbsp;imagewidth,imageheight);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="html" style="display: none;">function sendphoto() {

    imagedata = context.getImageData(0, 0, imagewidth,imageheight);

    var canvaspixelarray = imagedata.data;

    
    var canvaspixellen = canvaspixelarray.length;
    var bytearray = new Uint8Array(canvaspixellen);

    for (var i=0;i&lt;canvaspixellen;++i) {
        bytearray[i] = canvaspixelarray[i];
    }

    connection.send(bytearray.buffer);
    context.fillStyle = '#ffffff';
    context.fillRect(0, 0, imagewidth,imageheight);    
}</pre>

<p></p><p><span style=" color: rgb(51, 51, 51); "><strong>疑问</strong></span></p><p><span style="color: rgb(51, 51, 51); ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>理论上来看，类型数组的性能毫无疑问比普通数组更快，但是根据《<a target="_blank" href="http://blog.n01se.net/?p=248">现代浏览器里类型数组的性能</a>》一文中的评测，可以看到某些操作和某些浏览器下，类型数组的性能反而更低，另外imageData和ArrayBuffer的性能在同一浏览器中还有不同的表现。这个现象让人困惑，因为imageData和ArrayBuffer其实就是为了性能敏感的功能诞生的，理论上能够提供更快的读取和写入速度。这有极大可能是目前浏览器厂商对于二进制数组优化不足造成的。我希望浏览器未来对于类型数组能有更好的支持。</p><p style="text-align: center;"><img src="http://namepk.sinaapp.com/blog/typedarray/6.jpg" alt=""><br></p><p> </p><p align="center">某些操作和浏览器下，类型数组性能反而更低</p><p><strong><span style="color:#333333;">总结</span></strong></p><p><span style="color: rgb(51, 51, 51); text-align: -webkit-left; ">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>随着HTML5 Canvas、WebSocket等新特性的出现，WebApp能做的事情越来越多，同时Web App对于性能要求也越来越高，Javascript类型数组正是在这种情况下应运而生的。随着IE、Chrome、Opera等主流浏览器逐步提供对它的全面支持，以及可预期的性能优化，它将会发挥越来越重要的作用。</p><p>&nbsp;</p><p><strong>附：<a target="_blank" href="http://caniuse.com/#feat=typedarrays">类型数组的浏览器支持情况</a></strong></p>
</div>

</div>