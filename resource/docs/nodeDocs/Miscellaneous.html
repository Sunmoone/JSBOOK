<div class="_page _node"><h1 id="addons_addons">Addons</h1> <p>Addons are dynamically linked shared objects. They can provide glue to C and C++ libraries. The API (at the moment) is rather complex, involving knowledge of several libraries: </p> <ul>
<li>
<p>V8 JavaScript, a C++ library. Used for interfacing with JavaScript: creating objects, calling functions, etc. Documented mostly in the <code>v8.h</code> header file (<code>deps/v8/include/v8.h</code> in the Node source tree), which is also available <a href="http://izs.me/v8-docs/main.html">online</a>.</p> </li> <li>
<p><a href="https://github.com/joyent/libuv">libuv</a>, C event loop library. Anytime one needs to wait for a file descriptor to become readable, wait for a timer, or wait for a signal to be received one will need to interface with libuv. That is, if you perform any I/O, libuv will need to be used.</p> </li> <li>
<p>Internal Node libraries. Most importantly is the <code>node::ObjectWrap</code> class which you will likely want to derive from.</p> </li> <li>
<p>Others. Look in <code>deps/</code> for what else is available.</p> </li> </ul>
<p>Node statically compiles all its dependencies into the executable. When compiling your module, you don't need to worry about linking to any of these libraries. </p> <p>All of the following examples are available for <a href="https://github.com/rvagg/node-addon-examples">download</a> and may be used as a starting-point for your own Addon. </p> <h2 id="addons_hello_world">Hello world</h2> <p>To get started let's make a small Addon which is the C++ equivalent of the following JavaScript code: </p> <pre class=" language-javascript"><code class=" language-javascript">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">'world'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre> <p>First we create a file <code>hello.cc</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>v8<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

using namespace v8<span class="token punctuation">;</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">Method<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token function">init<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  exports<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>Method<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>hello<span class="token punctuation">,</span> init<span class="token punctuation">)</span></code></pre> <p>Note that all Node addons must export an initialization function: </p> <pre class=" language-javascript"><code class=" language-javascript">void Initialize <span class="token punctuation">(</span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>module_name<span class="token punctuation">,</span> Initialize<span class="token punctuation">)</span></code></pre> <p>There is no semi-colon after <code>NODE_MODULE</code> as it's not a function (see <code>node.h</code>). </p> <p>The <code>module_name</code> needs to match the filename of the final binary (minus the .node suffix). </p> <p>The source code needs to be built into <code>hello.node</code>, the binary Addon. To do this we create a file called <code>binding.gyp</code> which describes the configuration to build your module in a JSON-like format. This file gets compiled by <a href="https://github.com/TooTallNate/node-gyp">node-gyp</a>. </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"targets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"target_name"</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>
      <span class="token string">"sources"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"hello.cc"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre> <p>The next step is to generate the appropriate project build files for the current platform. Use <code>node-gyp configure</code> for that. </p> <p>Now you will have either a <code>Makefile</code> (on Unix platforms) or a <code>vcxproj</code> file (on Windows) in the <code>build/</code> directory. Next invoke the <code>node-gyp build</code> command. </p> <p>Now you have your compiled <code>.node</code> bindings file! The compiled bindings end up in <code>build/Release/</code>. </p> <p>You can now use the binary addon in a Node project <code>hello.js</code> by pointing <code>require</code> to the recently built <code>hello.node</code> module: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> addon <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>addon<span class="token punctuation">.</span><span class="token function">hello<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 'world'</span></code></pre> <p>Please see patterns below for further information or </p> <p><a href="https://github.com/arturadib/node-qt">https://github.com/arturadib/node-qt</a> for an example in production. </p> <h2 id="addons_addon_patterns">Addon patterns</h2> <p>Below are some addon patterns to help you get started. Consult the online <a href="http://izs.me/v8-docs/main.html">v8 reference</a> for help with the various v8 calls, and v8's <a href="http://code.google.com/apis/v8/embed.html">Embedder's Guide</a> for an explanation of several concepts used such as handles, scopes, function templates, etc. </p> <p>In order to use these examples you need to compile them using <code>node-gyp</code>. Create the following <code>binding.gyp</code> file: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"targets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"target_name"</span><span class="token punctuation">:</span> <span class="token string">"addon"</span><span class="token punctuation">,</span>
      <span class="token string">"sources"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"addon.cc"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre> <p>In cases where there is more than one <code>.cc</code> file, simply add the file name to the <code>sources</code> array, e.g.: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token string">"sources"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"addon.cc"</span><span class="token punctuation">,</span> <span class="token string">"myexample.cc"</span><span class="token punctuation">]</span></code></pre> <p>Now that you have your <code>binding.gyp</code> ready, you can configure and build the addon: </p> <pre class=" language-javascript"><code class=" language-javascript">$ node<span class="token operator">-</span>gyp configure build</code></pre> <h3 id="addons_function_arguments">Function arguments</h3> <p>The following pattern illustrates how to read arguments from JavaScript function calls and return a result. This is the main and only needed source <code>addon.cc</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

using namespace v8<span class="token punctuation">;</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">Add<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">Length<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ThrowException<span class="token punctuation">(</span></span>Exception<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">TypeError<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span><span class="token string">"Wrong number of arguments"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span><span class="token function">Undefined<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">IsNumber<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">IsNumber<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ThrowException<span class="token punctuation">(</span></span>Exception<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">TypeError<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span><span class="token string">"Wrong arguments"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span><span class="token function">Undefined<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Local<span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span> num <span class="token operator">=</span> Number<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NumberValue<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">+</span>
      args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NumberValue<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token function">Init<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  exports<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>Add<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>addon<span class="token punctuation">,</span> Init<span class="token punctuation">)</span></code></pre> <p>You can test it with the following JavaScript snippet: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> addon <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> <span class="token string">'This should be eight:'</span><span class="token punctuation">,</span> addon<span class="token punctuation">.</span><span class="token function">add<span class="token punctuation">(</span></span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> <h3 id="addons_callbacks">Callbacks</h3> <p>You can pass JavaScript functions to a C++ function and execute them from there. Here's <code>addon.cc</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

using namespace v8<span class="token punctuation">;</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">RunCallback<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> cb <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Cast<span class="token punctuation">(</span></span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  const unsigned argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span><span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  cb<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Call<span class="token punctuation">(</span></span>Context<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">GetCurrent<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Global<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span><span class="token function">Undefined<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token function">Init<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"exports"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>RunCallback<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>addon<span class="token punctuation">,</span> Init<span class="token punctuation">)</span></code></pre> <p>Note that this example uses a two-argument form of <code>Init()</code> that receives the full <code>module</code> object as the second argument. This allows the addon to completely overwrite <code>exports</code> with a single function instead of adding the function as a property of <code>exports</code>. </p> <p>To test it run the following JavaScript snippet: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> addon <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">addon<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 'hello world'
</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> <h3 id="addons_object_factory">Object factory</h3> <p>You can create and return new objects from within a C++ function with this <code>addon.cc</code> pattern, which returns an object with property <code>msg</code> that echoes the string passed to <code>createObject()</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

using namespace v8<span class="token punctuation">;</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">CreateObject<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> obj <span class="token operator">=</span> Object<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ToString<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token function">Init<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"exports"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>CreateObject<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>addon<span class="token punctuation">,</span> Init<span class="token punctuation">)</span></code></pre> <p>To test it in JavaScript: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> addon <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token function">addon<span class="token punctuation">(</span></span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token function">addon<span class="token punctuation">(</span></span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>obj1<span class="token punctuation">.</span>msg<span class="token operator">+</span><span class="token string">' '</span><span class="token operator">+</span>obj2<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 'hello world'</span></code></pre> <h3 id="addons_function_factory">Function factory</h3> <p>This pattern illustrates how to create and return a JavaScript function that wraps a C++ function: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

using namespace v8<span class="token punctuation">;</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">MyFunction<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span><span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">CreateFunction<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>MyFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> fn <span class="token operator">=</span> tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fn<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetName<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"theFunction"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // omit this to make it anonymous
</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token function">Init<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"exports"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>CreateFunction<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>addon<span class="token punctuation">,</span> Init<span class="token punctuation">)</span></code></pre> <p>To test: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> addon <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token function">addon<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token function">fn<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 'hello world'</span></code></pre> <h3 id="addons_wrapping_c_objects">Wrapping C++ objects</h3> <p>Here we will create a wrapper for a C++ object/class <code>MyObject</code> that can be instantiated in JavaScript through the <code>new</code> operator. First prepare the main module <code>addon.cc</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token string">"myobject.h"</span>

using namespace v8<span class="token punctuation">;</span>

void <span class="token function">InitAll<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Init<span class="token punctuation">(</span></span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>addon<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span></code></pre> <p>Then in <code>myobject.h</code> make your wrapper inherit from <code>node::ObjectWrap</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#ifndef MYOBJECT_H
#define MYOBJECT_H

#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

class <span class="token class-name">MyObject</span> <span class="token punctuation">:</span> public node<span class="token punctuation">:</span><span class="token punctuation">:</span>ObjectWrap <span class="token punctuation">{</span>
 public<span class="token punctuation">:</span>
  static void <span class="token function">Init<span class="token punctuation">(</span></span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>

 private<span class="token punctuation">:</span>
  explicit <span class="token function">MyObject<span class="token punctuation">(</span></span>double value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token operator">&gt;</span> <span class="token function">New<span class="token punctuation">(</span></span>const v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token operator">&gt;</span> <span class="token function">PlusOne<span class="token punctuation">(</span></span>const v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Persistent<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Function<span class="token operator">&gt;</span> constructor<span class="token punctuation">;</span>
  double value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

#endif</code></pre> <p>And in <code>myobject.cc</code> implement the various methods that you want to expose. Here we expose the method <code>plusOne</code> by adding it to the constructor's prototype: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token string">"myobject.h"</span>

using namespace v8<span class="token punctuation">;</span>

Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">MyObject<span class="token punctuation">(</span></span>double value<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">value_<span class="token punctuation">(</span></span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">MyObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

void MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Init<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment" spellcheck="true"> // Prepare constructor template
</span>  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetClassName<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">InstanceTemplate<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetInternalFieldCount<span class="token punctuation">(</span></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment" spellcheck="true"> // Prototype
</span>  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">PrototypeTemplate<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"plusOne"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>PlusOne<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor <span class="token operator">=</span> Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  exports<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Invoked as constructor: `new MyObject(...)`
</span>    double value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">IsUndefined<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NumberValue<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Wrap<span class="token punctuation">(</span></span>args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Invoked as plain function `MyObject(...)`, turn into construct call.
</span>    const int argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>constructor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">PlusOne<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> ObjectWrap<span class="token punctuation">:</span><span class="token punctuation">:</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-</span><span class="token operator">&gt;</span>value_ <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>Number<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>obj<span class="token operator">-</span><span class="token operator">&gt;</span>value_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> <p>Test it with: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> addon <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">addon<span class="token punctuation">.</span>MyObject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 11
</span>console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 12
</span>console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 13</span></code></pre> <h3 id="addons_factory_of_wrapped_objects">Factory of wrapped objects</h3> <p>This is useful when you want to be able to create native objects without explicitly instantiating them with the <code>new</code> operator in JavaScript, e.g. </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
// instead of:
</span><span class="token comment" spellcheck="true">// var obj = new addon.Object();</span></code></pre> <p>Let's register our <code>createObject</code> method in <code>addon.cc</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token string">"myobject.h"</span>

using namespace v8<span class="token punctuation">;</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">CreateObject<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token function">InitAll<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Init<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  module<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"exports"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>CreateObject<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>addon<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span></code></pre> <p>In <code>myobject.h</code> we now introduce the static method <code>NewInstance</code> that takes care of instantiating the object (i.e. it does the job of <code>new</code> in JavaScript): </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#ifndef MYOBJECT_H
#define MYOBJECT_H

#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

class <span class="token class-name">MyObject</span> <span class="token punctuation">:</span> public node<span class="token punctuation">:</span><span class="token punctuation">:</span>ObjectWrap <span class="token punctuation">{</span>
 public<span class="token punctuation">:</span>
  static void <span class="token function">Init<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token operator">&gt;</span> <span class="token function">NewInstance<span class="token punctuation">(</span></span>const v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

 private<span class="token punctuation">:</span>
  explicit <span class="token function">MyObject<span class="token punctuation">(</span></span>double value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token operator">&gt;</span> <span class="token function">New<span class="token punctuation">(</span></span>const v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token operator">&gt;</span> <span class="token function">PlusOne<span class="token punctuation">(</span></span>const v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Persistent<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Function<span class="token operator">&gt;</span> constructor<span class="token punctuation">;</span>
  double value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

#endif</code></pre> <p>The implementation is similar to the above in <code>myobject.cc</code>: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token string">"myobject.h"</span>

using namespace v8<span class="token punctuation">;</span>

Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">MyObject<span class="token punctuation">(</span></span>double value<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">value_<span class="token punctuation">(</span></span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">MyObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

void MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Init<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment" spellcheck="true"> // Prepare constructor template
</span>  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetClassName<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">InstanceTemplate<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetInternalFieldCount<span class="token punctuation">(</span></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment" spellcheck="true"> // Prototype
</span>  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">PrototypeTemplate<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"plusOne"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>PlusOne<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor <span class="token operator">=</span> Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Invoked as constructor: `new MyObject(...)`
</span>    double value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">IsUndefined<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NumberValue<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Wrap<span class="token punctuation">(</span></span>args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Invoked as plain function `MyObject(...)`, turn into construct call.
</span>    const int argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>constructor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  const unsigned argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> instance <span class="token operator">=</span> constructor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">PlusOne<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> ObjectWrap<span class="token punctuation">:</span><span class="token punctuation">:</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-</span><span class="token operator">&gt;</span>value_ <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>Number<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>obj<span class="token operator">-</span><span class="token operator">&gt;</span>value_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> <p>Test it with: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> createObject <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token function">createObject<span class="token punctuation">(</span></span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 11
</span>console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 12
</span>console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 13
</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token function">createObject<span class="token punctuation">(</span></span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj2<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 21
</span>console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj2<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 22
</span>console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span> obj2<span class="token punctuation">.</span><span class="token function">plusOne<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 23</span></code></pre> <h3 id="addons_passing_wrapped_objects_around">Passing wrapped objects around</h3> <p>In addition to wrapping and returning C++ objects, you can pass them around by unwrapping them with Node's <code>node::ObjectWrap::Unwrap</code> helper function. In the following <code>addon.cc</code> we introduce a function <code>add()</code> that can take on two <code>MyObject</code> objects: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token string">"myobject.h"</span>

using namespace v8<span class="token punctuation">;</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">CreateObject<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> <span class="token function">Add<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj1 <span class="token operator">=</span> node<span class="token punctuation">:</span><span class="token punctuation">:</span>ObjectWrap<span class="token punctuation">:</span><span class="token punctuation">:</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ToObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  MyObject<span class="token operator">*</span> obj2 <span class="token operator">=</span> node<span class="token punctuation">:</span><span class="token punctuation">:</span>ObjectWrap<span class="token punctuation">:</span><span class="token punctuation">:</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ToObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  double sum <span class="token operator">=</span> obj1<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Value<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> obj2<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Value<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>Number<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token function">InitAll<span class="token punctuation">(</span></span>Handle<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Init<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  exports<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"createObject"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>CreateObject<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  exports<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>Add<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE<span class="token punctuation">(</span></span>addon<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span></code></pre> <p>To make things interesting we introduce a public method in <code>myobject.h</code> so we can probe private values after unwrapping the object: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#ifndef MYOBJECT_H
#define MYOBJECT_H

#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>

class <span class="token class-name">MyObject</span> <span class="token punctuation">:</span> public node<span class="token punctuation">:</span><span class="token punctuation">:</span>ObjectWrap <span class="token punctuation">{</span>
 public<span class="token punctuation">:</span>
  static void <span class="token function">Init<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token operator">&gt;</span> <span class="token function">NewInstance<span class="token punctuation">(</span></span>const v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  double <span class="token function">Value<span class="token punctuation">(</span></span><span class="token punctuation">)</span> const <span class="token punctuation">{</span> <span class="token keyword">return</span> value_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 private<span class="token punctuation">:</span>
  explicit <span class="token function">MyObject<span class="token punctuation">(</span></span>double value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token operator">&gt;</span> <span class="token function">New<span class="token punctuation">(</span></span>const v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  static v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Persistent<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Function<span class="token operator">&gt;</span> constructor<span class="token punctuation">;</span>
  double value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

#endif</code></pre> <p>The implementation of <code>myobject.cc</code> is similar as before: </p> <pre class=" language-javascript"><code class=" language-javascript">#define BUILDING_NODE_EXTENSION
#include <span class="token operator">&lt;</span>node<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token string">"myobject.h"</span>

using namespace v8<span class="token punctuation">;</span>

Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">MyObject<span class="token punctuation">(</span></span>double value<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">value_<span class="token punctuation">(</span></span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">MyObject<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

void MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Init<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment" spellcheck="true"> // Prepare constructor template
</span>  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetClassName<span class="token punctuation">(</span></span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewSymbol<span class="token punctuation">(</span></span><span class="token string">"MyObject"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">InstanceTemplate<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetInternalFieldCount<span class="token punctuation">(</span></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor <span class="token operator">=</span> Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>tpl<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetFunction<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">New<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Invoked as constructor: `new MyObject(...)`
</span>    double value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">IsUndefined<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NumberValue<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Wrap<span class="token punctuation">(</span></span>args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">This<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Invoked as plain function `MyObject(...)`, turn into construct call.
</span>    const int argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>constructor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> MyObject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>const Arguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleScope scope<span class="token punctuation">;</span>

  const unsigned argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Handle<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> instance <span class="token operator">=</span> constructor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewInstance<span class="token punctuation">(</span></span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">Close<span class="token punctuation">(</span></span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> <p>Test it with: </p> <pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> addon <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> obj1 <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject<span class="token punctuation">(</span></span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject<span class="token punctuation">(</span></span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">add<span class="token punctuation">(</span></span>obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 30</span></code></pre><div class="_attribution">
  <p class="_attribution-p">
    © Joyent, Inc. and other Node contributors<br>Licensed under the MIT License.<br>
    <a href="http://nodejs.org/api/addons.html" class="_attribution-link">http://nodejs.org/api/addons.html</a>
  </p>
</div>
</div>