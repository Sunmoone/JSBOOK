<div id="cnblogs_post_body"><div class="g_t_left c07 content" id="blogtext_fks_087075082084089066093082083095080086085070087086083067"><font face="Tahoma">这几天做了一些drag&amp;drop操作方面的工作，在这里把一些注意事项记录下来，算是给自己备个忘，也给需要做类似工作的人留个树阴。这里要讨论的drag&amp;drop是指使用IE提供的内置机制，而不是使用鼠标模拟的那种"假"drag&amp;drop，比如移动一个div或span的效果那种。<br>
<br>
&nbsp;&nbsp;&nbsp; 要实现和控制drag&amp;drop操作，那么首先第一点要弄清楚的是，到底哪些元素是可以在Web上被drag的？实际上IE默认给我们并让我们drag的元素并不多，它们是：<strong>图片</strong>、<strong>选中的文字</strong>（包括页面文字和文字控件(input, textarea)中的文字）和<strong>连接</strong>（普通连接和锚点）。除此之外，别的Web元素默认都不支持drag操作（在这些元素上面drag其实就是选择操作了），所以要实现对元素默认的drag&amp;drop控制，只能选这3类元素来操作。<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="Tahoma"><font color="#0000ff">在BizStruct同学的斧正中提到，其实几乎所有的Html元素都是支持drag&amp;drop的（见其<a href="http://birdshome.cnblogs.com/archive/2006/07/22/Drag_Drop.html#457694"><font color="#1d58d1">回复</font></a>），在此表示由衷的感谢。<br>
</font><br>
&nbsp;&nbsp;&nbsp; 接下来，那么哪些元素又是可以接受drop操作呢？任何页面上的可见元素都是可以接受drop操作的，而它们之间的不同只是在于默认的drop事件不一样。比如，文字控件(input, textarea)的默认drop事件就是获取drag操作传过来的文字内容；iframe元素的默认drop操作是到航道drag操作传过来的URL地址。当然绝大多数的Web元素的默认是操作是do nothing，什么也不做。<br>
<br>
&nbsp;&nbsp;&nbsp; 那么当进行drag&amp;drop操作时，有那些是可控制和定制的内容呢？这里关于drag&amp;drop提供了以下一些事件（我们把它们分为作用于<strong>来源对象</strong>和<strong>目的对象</strong>来分别讨论），先讨论主要作用于<strong>来源对象</strong>的事件：<br>
&nbsp;&nbsp;&nbsp;·ondrag —— 在整个从drag动作开始，直道drop动作结束的过程中，都会触发的一个事件。<br>
&nbsp;&nbsp;&nbsp;·ondragstart —— 在drag动作开始时，在来源对象上触发的一个事件。<br>
&nbsp;&nbsp;&nbsp;·ondragend —— 在drop动作结束的时候，在来源对象上出发的一个事件。<br>
<br>
&nbsp;&nbsp;&nbsp;而主要做要在<strong>目的对象</strong>上的事件：<br>
&nbsp;&nbsp;&nbsp;·ondragenter —— 在drag动作进入某一有效目的元素时，在该目的元素上触发的一个事件。<br>
&nbsp;&nbsp;&nbsp;·ondragover —— 在drag动作进入某一有效目的元素后，在该目的元素上触发的一个事件。<br>
&nbsp;&nbsp;&nbsp;·ondragleave —— 在drag动作离开某一有效目的元素时，在该目的元素上触发的一个事件。<br>
&nbsp;&nbsp;&nbsp;·ondrop —— 在任何有效目的元素上进行drop操作时，在该目的元素上触发的一个事件。<br>
<br>
&nbsp;&nbsp;&nbsp; 这里的来源和目的的划分不是绝对的，比如ondragover事件，在drag操作过程中，如果鼠标进入了<strong>来源对象</strong>中，同样的也会触发这个事件。这些事件触发的顺序是：来源对象 --&gt; ondragstart --&gt; ondrag --&gt; ondragend；目的对象 --&gt; ondragenter --&gt; ondragover --&gt; ( ondragleave&nbsp;| ondrap )。由于是分别在同一个对象上触发的事件，所以这个顺序很简单。那么对于一个完整的从来源对象到目的对象的drag&amp;drop操作来说，事件的触发序列又是怎样呢？如果<font color="#ff0000">src</font>表示来源对象，<font color="#0000ff">des</font>表示目的对象，那么事件触发序列为：<br>
<br>
&nbsp;&nbsp;&nbsp; <font color="#ff0000">src</font>:ondragstart --&gt; <font color="#ff0000">src</font>:ondrag --&gt; <font color="#0000ff">des</font>:ondragenter --&gt; <font color="#0000ff">des</font>:ondragover --&gt; (&nbsp;<font color="#0000ff">des</font>:ondragleave | <font color="#0000ff">des</font>:ondrop )&nbsp;--&gt; <font color="#ff0000">src</font>:ondragend.<br>
<br>
&nbsp;&nbsp;&nbsp; 示例为：</font><a style="border-right: red 1px solid; border-top: red 1px solid; border-left: red 1px solid; width: 240px; cursor: default; color: red; border-bottom: red 1px solid; text-align: center; text-decoration: none" href="http://www.cnblogs.com/birdshome/archive/2006/07/22/Drag_Drop.html#" return="" true;?="" src:on?+event.type)?="" false;?=""><font face="Tahoma">Drag Source</font></a><font face="Tahoma"> </font><span style="border-right: blue 1px solid; border-top: blue 1px solid; border-left: blue 1px solid; width: 240px; cursor: default; color: blue; border-bottom: blue 1px solid; text-align: center" des:on?+event.type)?=""><font face="Tahoma">Drop Destination</font></span><br>
<font face="Tahoma">&nbsp;&nbsp;&nbsp;&nbsp;</font><em><font face="Tahoma" color="#808080">// 如果alert窗口不响应鼠标点击可以使用键盘的space键来确定窗口<br>
</font></em>
<div style="border-right: #cccccc 1px solid; padding-right: 5px; border-top: #cccccc 1px solid; padding-left: 4px; font-size: 13px; padding-bottom: 4px; border-left: #cccccc 1px solid; width: 98%; word-break: break-all; padding-top: 4px; border-bottom: #cccccc 1px solid; background-color: #eeeeee"><font face="Tahoma"><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" alt=""><span style="color: #0000ff">&lt;</span><span style="color: #800000">A&nbsp;</span><span style="color: #ff0000">onmouseover</span><span style="color: #0000ff">="status=this.innerText;&nbsp;return&nbsp;true;"</span><span style="color: #ff0000">&nbsp;</span><span style="color: #ff0000">ondragend</span><span style="color: #0000ff">="alert('src:on'+event.type)"</span><span style="color: #ff0000">&nbsp;onclick</span><span style="color: #0000ff">="return&nbsp;false;"</span><span style="color: #0000ff">&gt;</span><span style="color: #000000">Drag&nbsp;Source</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">A</span><span style="color: #0000ff">&gt;</span></font><span style="color: #000000"><br>
<font face="Tahoma"><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" alt=""></font></span><font face="Tahoma"><span style="color: #0000ff">&lt;</span><span style="color: #800000">SPAN&nbsp;</span><span style="color: #ff0000">ondrop</span><span style="color: #0000ff">="alert('des:on'+event.type)"</span><span style="color: #ff0000">&nbsp;</span><span style="color: #ff0000">ondragleave</span><span style="color: #0000ff">="alert('des:on'+event.type)"</span><span style="color: #0000ff">&gt;</span><span style="color: #000000">Drop&nbsp;Destination</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">SPAN</span><span style="color: #0000ff">&gt;</span></font></div>
<br>
<font face="Tahoma">&nbsp;&nbsp;&nbsp;&nbsp;了解了事件触发顺序后，定制drag&amp;drop过程中鼠标的光标形状也是非常重要的一个内容。因为用户的drag&amp;drop的整个过程都需要靠鼠标光标的形状指导其进行操作，如果不能实时的调整光标为适合的型状，drag&amp;drop操作对用户来说将无异于朦眼寻物。IE提供了用来控制的drag&amp;drop过程中光标形状的两个属性，它们是：effectAllowed和dropEffect。<br>
<br>
&nbsp;&nbsp;&nbsp; 其属性分别为：<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ·<strong>effectAllowed</strong>:&nbsp;copy, link, move, copyLink, copyMove, all,&nbsp;none &amp; uninitialized.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;·<strong>dropEffect</strong>: copy, link, move, none.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;前者effectAllowed是用来控制允许drag&amp;drop操作类型的，所以这里的effect不是显示的"效果"，而是是否可以执行的"操作"，并且该属性只能在ondragstart事件中进行初始化，之后再对其赋值将无效。当然如果只使用effectAllowed属性，就已经可以达到控制光标形状的作用了。只是effectAllowed属性在处理复合操作时，比如copyLink, copyMove和all，会默认显示靠前那个操作类型的鼠标类型。也就是说如果effectAllowed是copyMove，那么这是鼠标光标就是copy形状。这下就知道为什么还要弄个dropEffect属性了吧？不过这个dropEffect属性中指定的effect，只能是之前effectAllowed允许的操作类型范围中的值，否则没有效果（显示no-drop鼠标光标）。<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp; 示例为：</font><a style="border-right: red 1px solid; border-top: red 1px solid; border-left: red 1px solid; width: 240px; cursor: default; color: red; border-bottom: red 1px solid; text-align: center; text-decoration: none" href="http://www.cnblogs.com/birdshome/archive/2006/07/22/Drag_Drop.html#" return="" true;?="" false;?="" copymove?;="" ?="" move?;="" cancelbubble="true;&quot;" event.="" returnvalue="false;" dropeffect="move" event.datatransfer.=""><font face="Tahoma"> Drag Source</font></a><font face="Tahoma"> </font><span style="border-right: blue 1px solid; border-top: blue 1px solid; border-left: blue 1px solid; width: 240px; cursor: default; color: blue; border-bottom: blue 1px solid; text-align: center" cancelbubble="true;&quot;" event.="" returnvalue="false;" copy?;&13;&10;&9;&9;&9;event.=""><font face="Tahoma">Drop Destination</font></span><br>
<div style="border-right: #cccccc 1px solid; padding-right: 5px; border-top: #cccccc 1px solid; padding-left: 4px; font-size: 13px; padding-bottom: 4px; border-left: #cccccc 1px solid; width: 98%; word-break: break-all; padding-top: 4px; border-bottom: #cccccc 1px solid; background-color: #eeeeee"><font face="Tahoma"><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" alt=""><span style="color: #0000ff">&lt;</span><span style="color: #800000">A&nbsp;</span><span style="color: #ff0000">ondragstart</span><span style="color: #0000ff">="event.dataTransfer.effectAllowed='copyMove';&nbsp;event.dataTransfer.dropEffect='move'"</span><span style="color: #ff0000">&nbsp;onmouseover</span><span style="color: #0000ff">="status=this.innerText;&nbsp;return&nbsp;true;"</span><span style="color: #ff0000">&nbsp;ondragover</span><span style="color: #0000ff">="event.dataTransfer.dropEffect='move';&nbsp;event.returnValue=false;&nbsp;event.cancelBubble=true;"</span><span style="color: #ff0000">&nbsp;onclick</span><span style="color: #0000ff">="return&nbsp;false;"</span><span style="color: #0000ff">&gt;</span><span style="color: #000000">Drag&nbsp;Source</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">A</span><span style="color: #0000ff">&gt;</span></font><span style="color: #000000"><br>
<font face="Tahoma"><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" alt=""></font></span><font face="Tahoma"><span style="color: #0000ff">&lt;</span><span style="color: #800000">SPAN&nbsp;</span><span style="color: #ff0000">ondragover</span><span style="color: #0000ff">="event.dataTransfer.dropEffect='copy';&nbsp;event.returnValue=false;&nbsp;event.cancelBubble=true;"</span><span style="color: #0000ff">&gt;</span><span style="color: #000000">Drop&nbsp;Destination</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">SPAN</span><span style="color: #0000ff">&gt;</span></font></div>
<br>
<font face="Tahoma">&nbsp;&nbsp;&nbsp; 查看代码时注意，你会发现在src和des的对象元素中，在ondragover事件里除了对dropEffect赋以适当的值外，还有两句话： </font>
<div style="border-right: #cccccc 1px solid; padding-right: 5px; border-top: #cccccc 1px solid; padding-left: 4px; font-size: 13px; padding-bottom: 4px; border-left: #cccccc 1px solid; width: 98%; word-break: break-all; padding-top: 4px; border-bottom: #cccccc 1px solid; background-color: #eeeeee"><font face="Tahoma"><span style="color: #000000">&nbsp;&nbsp; event.returnValue</span><span style="color: #000000">=</span><span style="color: #0000ff">false</span></font><font face="Tahoma"><span style="color: #000000">;<br>
&nbsp;&nbsp; event.cancelBubble</span><span style="color: #000000">=</span><span style="color: #0000ff">true</span><span style="color: #000000">;</span></font></div>
<br>
<font face="Tahoma">&nbsp;&nbsp;&nbsp; 只是由于页面元素在接受dragover的时候，本身都有其默认的鼠标光标显示型状，所以为了让用户自定义的鼠标光标生效，就需要使事件event的returenValue为false值并停止当事件的冒泡(event.cancelBubble=true)。<br>
<br>
&nbsp;&nbsp;&nbsp; 到目前为止，一个完整的drag&amp;drop过程就差数据传递了，其实忙活了半天，这才是藏在所有交互操作和显示效果下面最重要的步骤。这个过程需要借助于IE提供的DHTML Data Transfer对象来完成，在window对象的属性event对象中，分别有两个Data Transfer对象各自的一个实例：一个叫dataTransfer，另一个叫clipboardData。这两个对象实例的行为非常相似，但又有一些区别，clipboardData顾名思义，它使用操作系统的剪贴板来存取数据，并有3个方法；而dataTransfer通过操作一个自己的<strong>内部</strong>剪贴板来存取数据(每次ondragend事件触发后就自动清空了)，除了有和clipboardData相同的3个方法外，还有两个属性(就是前面介绍的那两个effectAllowed和dropEffect)。<br>
<br>
&nbsp;&nbsp;&nbsp; 我们这里不对clipboardData作更多的讨论，继续来看dataTransfer对象。它包含3个方法，它们是：setData(sDataFormat, sText), getData(sDataFormat)和clearData([sDataFormat])。它们更详细的使用和参数请参阅MSDN，这里我只用它们来实现drag&amp;drop的数据传递。<br>
<br>
&nbsp;&nbsp;&nbsp; 示例为：</font><a style="border-right: red 1px solid; border-top: red 1px solid; border-left: red 1px solid; width: 240px; cursor: default; color: red; border-bottom: red 1px solid; text-align: center; text-decoration: none" href="http://www.cnblogs.com/birdshome/archive/2006/07/22/Drag_Drop.html#" return="" true;?="" false;?="" copymove?;="" move?;="" ;&13;&10;&9;&9;event.datatransfer.setdata(?text?,="" this.innertext);?="" cancelbubble="true;&quot;" event.="" returnvalue="false;" dropeffect="move" event.datatransfer.=""><font face="Tahoma">Drag Source</font></a><font face="Tahoma"> </font><span style="border-right: blue 1px solid; border-top: blue 1px solid; border-left: blue 1px solid; width: 240px; cursor: default; color: blue; border-bottom: blue 1px solid; text-align: center" ;?="event.dataTransfer.getData('TEXT');&amp;13;&amp;10;&amp;9;&amp;9;&amp;9;&amp;9;this.style.color" cancelbubble="true;&quot;" event.="" returnvalue="false;" copy?;&13;&10;&9;&9;&9;event.=""><font face="Tahoma">Drop Destination</font></span><br>
<div style="border-right: #cccccc 1px solid; padding-right: 5px; border-top: #cccccc 1px solid; padding-left: 4px; font-size: 13px; padding-bottom: 4px; border-left: #cccccc 1px solid; width: 98%; word-break: break-all; padding-top: 4px; border-bottom: #cccccc 1px solid; background-color: #eeeeee"><font face="Tahoma"><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" alt=""><span style="color: #0000ff">&lt;</span><span style="color: #800000">A&nbsp;</span><span style="color: #ff0000">ondragstart</span><span style="color: #0000ff">="event.dataTransfer.effectAllowed='copyMove';&nbsp;event.dataTransfer.dropEffect='move';&nbsp;event.dataTransfer.setData('TEXT',&nbsp;this.innerText);"</span><span style="color: #ff0000">&nbsp;onmouseover</span><span style="color: #0000ff">="status=this.innerText;&nbsp;return&nbsp;true;"</span><span style="color: #ff0000">&nbsp;ondragover</span><span style="color: #0000ff">="event.dataTransfer.dropEffect='move';&nbsp;event.returnValue=false;&nbsp;event.cancelBubble=true;"</span><span style="color: #ff0000">&nbsp;onclick</span><span style="color: #0000ff">="return&nbsp;false;"</span><span style="color: #0000ff">&gt;</span><span style="color: #000000">Drag&nbsp;Source</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">A</span><span style="color: #0000ff">&gt;</span></font><span style="color: #000000"><br>
<font face="Tahoma"><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" align="top" alt=""></font></span><font face="Tahoma"><span style="color: #0000ff">&lt;</span><span style="color: #800000">SPAN&nbsp;</span><span style="color: #ff0000">ondrop</span><span style="color: #0000ff">="this.innerText&nbsp;=&nbsp;event.dataTransfer.getData('TEXT');&nbsp;this.style.color&nbsp;=&nbsp;'red';"</span><span style="color: #ff0000">&nbsp;ondragover</span><span style="color: #0000ff">="event.dataTransfer.dropEffect='copy';&nbsp;event.returnValue=false;&nbsp;event.cancelBubble=true;"</span><span style="color: #0000ff">&gt;</span><span style="color: #000000">Drop&nbsp;Destination</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">SPAN</span><span style="color: #0000ff">&gt;</span></font></div>
<p><br>
<font face="Tahoma">&nbsp;&nbsp;&nbsp; 其实很简单，就是在src的ondragstart中，调用event.dataTransfer.setData('TEXT', this.innerText)，然后再des的ondrop事件中，调用this.innerText = event.dataTransfer.getData('TEXT')就行了。</font></p>
<p><font face="Tahoma"></font>&nbsp;</p>
<p><font face="Tahoma">TraceBack: <a href="http://www.cnblogs.com/birdshome/archive/2006/07/22/Drag_Drop.html">http://www.cnblogs.com/birdshome/archive/2006/07/22/Drag_Drop.html</a></font></p>
</div>
</div>