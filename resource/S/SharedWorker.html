在调试的过程中，仔细的去区别Worker和SharedWorker的不同。
Worker适用与一个application使用，而SharedWorker可以再同一个域下面不同的application使用，并且可以共享一些数据。
对于Worker来说，每次都创建一个实例，与只创建一个实例，需要的时候调用，其区别是线程中的数据每次都会重新初始化一次。
对于SharedWorker来说，每次都创建一个实例，与只创建一个实例，需要的时候调用，connect会被调用的次数不同，线程中数据共享。

最为怪异的是下面两行代码有很大的不同，
//sharedWker.port.addEventListener('message', sharedOnMessage, false); 
sharedWker.port.addEventListener('message', function(e) {}, false);
貌似第二行代码每次都会new一个新的function加入到其中，不断的执行过程中，这个函数会被调用若干次，而采用第一行语句就只会调用一次。
为什么会出现这样的情况？

<div id="topicList">
		

<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/dxy1982/archive/2012/08/06/2359202.html">突袭HTML5之Javascript API扩展1 - Web Worker异步执行</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><p><strong style="color: #0000ff">Javascript执行机制</strong><strong><br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在HTML5之前，浏览器中JavaScript的运行都是以单线程的方式工作的，虽然有多种方式实现了对多线程的模拟（例如：Javascript 中的 setinterval 方法，setTimeout 方法等），但是在本质上程序的运行仍然是由 JavaScript 引擎以单线程调度的方式进行的。在 HTML5 中引入的工作线程使得浏览器端的 Javascript 引擎可以并发地执行 Javascript 代码，从而实现了对浏览器端多线程编程的良好支持。</p>
<p><strong style="color: #0000ff">Javascript中的多线程 - WebWorker</strong><strong><br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HTML5 中的 Web Worker 可以分为两种不同线程类型，一个是专用线程 Dedicated Worker，一个是共享线程 Shared Worker。两种类型的线程各有不同的用途。</p>
<p><strong style="color: #ff6600">专用型web worker</strong></p>
<p>　　专用型worker与创建它的脚本连接在一起，它可以与其他的worker或是浏览器组件通信，但是他不能与DOM通信。专用的含义，我想就是这个线程一次只处理一个需求。专用线程在除了IE外的各种主流浏览器中都实现了，可以放心使用。<br><strong>创建线程<br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建worker很简单，只要把需要在线程中执行的JavaScript文件的文件名传给构造函数就可以了。</p>
<p><span><strong>线程通信</strong></span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在主线程与子线程间进行通信，使用的是线程对象的postMessage和onmessage方法。不管是谁向谁发数据，发送发使用的都是postMessage方法，接收方都是使用onmessage方法接收数据。postMessage只有一个参数，那就是传递的数据，onmessage也只有一个参数，假设为event，则通过event.data获取收到的数据。</p>
<p><strong>发送JSON数据<br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JSON是JS原生支持的东西，不用白不用，复杂的数据就用JSON传送吧。例如：</p>
<div class="cnblogs_code">
<div>postMessage({'cmd':&nbsp;'init',&nbsp;'timestamp':&nbsp;Date.now()});</div></div>
<p><strong>处理错误<br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 当线程发生错误的时候，它的onerror事件回调会被调用。所以处理错误的方式很简单，就是挂接线程实例的onerror事件。这个回调函数有一个参数error，这个参数有3个字段：message - 错误消息；filename - 发生错误的脚本文件；lineno - 发生错误的行。</p>
<p><strong>销毁线程<br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在线程内部，使用close方法线程自己销毁自己。在线程外部的主线程中，使用线程实例的terminate方法销毁线程。</p>
<p>下面从一个例子看线程的基本操作：<br>HTML代码：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<div><span style="color: #0000ff">&lt;!</span><span style="color: #ff00ff">DOCTYPE&nbsp;HTML</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;</span><span style="color: #800000">html</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;</span><span style="color: #800000">head</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;</span><span style="color: #800000">meta&nbsp;</span><span style="color: #ff0000">http-equiv</span><span style="color: #0000ff">="Content-Type"</span><span style="color: #ff0000">&nbsp;content</span><span style="color: #0000ff">="text/html;&nbsp;charset=utf-8"</span><span style="color: #ff0000">&nbsp;</span><span style="color: #0000ff">/&gt;</span><br><span style="color: #0000ff">&lt;</span><span style="color: #800000">title</span><span style="color: #0000ff">&gt;</span>web&nbsp;worker&nbsp;fibonacci<span style="color: #0000ff">&lt;/</span><span style="color: #800000">title</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;</span><span style="color: #800000">script&nbsp;</span><span style="color: #ff0000">type</span><span style="color: #0000ff">="text/javascript"</span><span style="color: #0000ff">&gt;</span><span style="background-color: #f5f5f5; color: #000000"><br>&nbsp;&nbsp;onload&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">function</span><span style="background-color: #f5f5f5; color: #000000">(){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">var</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;worker&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">new</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;Worker(</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">fibonacci.js</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">);&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;worker.onmessage&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">function</span><span style="background-color: #f5f5f5; color: #000000">(event)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(</span><span style="background-color: #f5f5f5; color: #000000">"</span><span style="background-color: #f5f5f5; color: #000000">Result:</span><span style="background-color: #f5f5f5; color: #000000">"</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">+</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;event.data);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;worker.onerror&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">function</span><span style="background-color: #f5f5f5; color: #000000">(error)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(</span><span style="background-color: #f5f5f5; color: #000000">"</span><span style="background-color: #f5f5f5; color: #000000">Error:</span><span style="background-color: #f5f5f5; color: #000000">"</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">+</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;error.message);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;worker.postMessage(</span><span style="background-color: #f5f5f5; color: #000000">40</span><span style="background-color: #f5f5f5; color: #000000">);<br>&nbsp;&nbsp;}&nbsp;&nbsp;<br>&nbsp;&nbsp;</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">script</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;/</span><span style="color: #800000">head</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;</span><span style="color: #800000">body</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;/</span><span style="color: #800000">body</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;/</span><span style="color: #800000">html</span><span style="color: #0000ff">&gt;</span></div><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>脚本文件fibonacci.js代码：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<div><span style="color: #008000">//</span><span style="color: #008000">fibonacci.js</span><span style="color: #008000"><br></span><span style="color: #0000ff">var</span>&nbsp;fibonacci&nbsp;=&nbsp;<span style="color: #0000ff">function</span>(n)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff">return</span>&nbsp;n&nbsp;&lt;&nbsp;2&nbsp;?&nbsp;n&nbsp;:&nbsp;arguments.callee(n&nbsp;-&nbsp;1)&nbsp;+&nbsp;arguments.callee(n&nbsp;-&nbsp;2);<br>};<br>onmessage&nbsp;=&nbsp;<span style="color: #0000ff">function</span>(event)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0000ff">var</span>&nbsp;n&nbsp;=&nbsp;parseInt(event.data,&nbsp;10);<br>&nbsp;&nbsp;&nbsp;&nbsp;postMessage(fibonacci(n));<br>};</div><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>把它们放到相同的目录，运行页面文件，查看控制台，可以看到运行的结果。<br>这里还有一点，在主线程中，onmessage事件可以使用另外一种方式挂接：</p>
<div class="cnblogs_code">
<div>worker.addEventListener('message',&nbsp;<span style="color: #0000ff">function</span>(event)&nbsp;{<br>&nbsp;&nbsp;&nbsp;console.log("Result:"&nbsp;+&nbsp;event.data);<br>},&nbsp;<span style="color: #0000ff">false</span>);</div></div>
<p>个人觉得很麻烦，不如用onmessage直接。</p>
<p><br><strong>使用其他脚本文件<br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 工作线程可以使用全局方法importScripts来加载和使用其他的域内脚本文件或者类库。例如下面都是合法的使用方式：</p>
<div class="cnblogs_code">
<div>importScripts();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #008000">/*</span><span style="color: #008000">&nbsp;imports&nbsp;nothing&nbsp;</span><span style="color: #008000">*/</span><br>importScripts('foo.js');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #008000">/*</span><span style="color: #008000">&nbsp;imports&nbsp;just&nbsp;"foo.js"&nbsp;</span><span style="color: #008000">*/</span><br>importScripts('foo.js',&nbsp;'bar.js');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #008000">/*</span><span style="color: #008000">&nbsp;imports&nbsp;two&nbsp;scripts&nbsp;</span><span style="color: #008000">*/</span></div></div>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 导入以后，可以直接使用这些文件中的方法。看一个网上的小例子：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<div><span style="color: #008000">/*</span><span style="color: #008000">*&nbsp;<br>&nbsp;*&nbsp;使用&nbsp;importScripts&nbsp;方法引入外部资源脚本，在这里我们使用了数学公式计算工具库&nbsp;math_utilities.js&nbsp;<br>&nbsp;*&nbsp;当&nbsp;JavaScript&nbsp;引擎对这个资源文件加载完毕后，继续执行下面的代码。同时，下面的的代码可以访问和调用<br>&nbsp;*&nbsp;在资源文件中定义的变量和方法。<br>&nbsp;*</span><span style="color: #008000">*/</span>&nbsp;<br>&nbsp;importScripts('math_utilities.js');&nbsp;<br>&nbsp;<br>&nbsp;onmessage&nbsp;=&nbsp;<span style="color: #0000ff">function</span>&nbsp;(event)&nbsp;<br>&nbsp;{&nbsp;<br>&nbsp;&nbsp; <span style="color: #0000ff">var</span>&nbsp;first = event.data.first;&nbsp;<br>&nbsp;&nbsp; <span style="color: #0000ff">var</span>&nbsp;second = event.data.second;&nbsp;<br>&nbsp;&nbsp; calculate(first,second);&nbsp;<br>&nbsp;};&nbsp;<br>&nbsp;<br>&nbsp;<span style="color: #0000ff">function</span>&nbsp;calculate(first,second)&nbsp;{&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #008000">//</span><span style="color: #008000">do&nbsp;the&nbsp;calculation&nbsp;work&nbsp;</span><span style="color: #008000"><br></span>&nbsp;&nbsp; <span style="color: #0000ff">var</span>&nbsp;common_divisor=divisor(first,second);&nbsp;<br>&nbsp;&nbsp; <span style="color: #0000ff">var</span>&nbsp;common_multiple=multiple(first,second);&nbsp;<br>&nbsp;&nbsp;&nbsp;postMessage("Work&nbsp;done!&nbsp;"&nbsp;+&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "The&nbsp;least&nbsp;common&nbsp;multiple&nbsp;is&nbsp;" + common_divisor&nbsp; + </div>
<div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "&nbsp;and&nbsp;the&nbsp;greatest&nbsp;common&nbsp;divisor&nbsp;is&nbsp;"+common_multiple);&nbsp;<br>&nbsp;}&nbsp;</div><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 网上也有网友想到了利用这里的importScripts方法解决资源预加载的问题(浏览器预先加载资源，而不会对资源进行解析和执行)，道理也很简单。</p>
<p>&nbsp;</p>
<p><strong>线程嵌套<br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在工作线程中还可以在创建子线程，各种操作还是一样的。</p>
<p><br><strong>同步问题<br></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Worker没有锁的机制，多线程的同步问题只能靠代码来解决（比如定义信号变量）。</p>
<p>&nbsp;</p>
<p><strong style="color: #ff6600">共享型SharedWebWorker</strong><strong><br></strong>　　共享型web worker主要适用于多连接并发的问题。因为要处理多连接，所以它的API与专用型worker稍微有点区别。除了这一点，共享型web worker和专用型worker一样，不能访问DOM，并且对窗体属性的访问也受到限制。共享型web worker也不能跨越通信。<br>　　页面脚本可以与共享型web worker通信，然而，与专用型web worker(使用了一个隐式的端口通信)稍微有点不同的是，通信是显式的通过使用一个端口(port)对象并附加上一个消息事件处理程序来进行的。</p>
<p>　　在收到web worker脚本的首个消息之后，共享型web worker把一个事件处理程序附加到激活的端口上。一般情况下，处理程序会运行自己的postMessage()方法来把一个消息返回给调用代码，接着端口的start()方法生成一个有效的消息进程。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 看网上能找到的的唯一个例子：创建一个共享线程用于接收从不同连接发送过来的指令，然后实现自己的指令处理逻辑，指令处理完成后将结果返回到各个不同的连接用户。<br>HTML代码：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<div><span style="color: #0000ff">&lt;!</span><span style="color: #ff00ff">DOCTYPE&nbsp;html</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">html</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">head</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">meta&nbsp;</span><span style="color: #ff0000">charset</span><span style="color: #0000ff">="UTF-8"</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">title</span><span style="color: #0000ff">&gt;</span>Shared&nbsp;worker&nbsp;example:&nbsp;how&nbsp;to&nbsp;use&nbsp;shared&nbsp;worker&nbsp;in&nbsp;HTML5<span style="color: #0000ff">&lt;/</span><span style="color: #800000">title</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">script</span><span style="color: #0000ff">&gt;</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;<br>&nbsp;&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">var</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;worker&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">new</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;SharedWorker(</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">sharedworker.js</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">);&nbsp;<br>&nbsp;&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">var</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;log&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;document.getElementById(</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">response_from_worker</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">);&nbsp;<br>&nbsp;&nbsp;worker.port.addEventListener(</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">message</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">,&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">function</span><span style="background-color: #f5f5f5; color: #000000">(e)&nbsp;{&nbsp;<br>&nbsp; </span><span style="background-color: #f5f5f5; color: #008000">//</span><span style="background-color: #f5f5f5; color: #008000">log&nbsp;the&nbsp;response&nbsp;data&nbsp;in&nbsp;web&nbsp;page&nbsp;</span><span style="background-color: #f5f5f5; color: #008000"><br></span><span style="background-color: #f5f5f5; color: #000000">&nbsp; log.textContent&nbsp;</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">e.data;&nbsp;<br>&nbsp;&nbsp;},&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">false</span><span style="background-color: #f5f5f5; color: #000000">);&nbsp;<br>&nbsp;&nbsp;worker.port.start();&nbsp;<br>&nbsp;&nbsp;worker.port.postMessage(</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">ping&nbsp;from&nbsp;user&nbsp;web&nbsp;page..</span><span style="background-color: #f5f5f5; color: #000000">'</span><span style="background-color: #f5f5f5; color: #000000">);&nbsp;<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;</span><span style="background-color: #f5f5f5; color: #008000">//</span><span style="background-color: #f5f5f5; color: #008000">following&nbsp;method&nbsp;will&nbsp;send&nbsp;user&nbsp;input&nbsp;to&nbsp;sharedworker&nbsp;</span><span style="background-color: #f5f5f5; color: #008000"><br></span><span style="background-color: #f5f5f5; color: #000000">&nbsp;&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">function</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;postMessageToSharedWorker(input)&nbsp;<br>&nbsp;&nbsp;{&nbsp;<br>&nbsp;&nbsp;</span><span style="background-color: #f5f5f5; color: #008000">//</span><span style="background-color: #f5f5f5; color: #008000">define&nbsp;a&nbsp;json&nbsp;object&nbsp;to&nbsp;construct&nbsp;the&nbsp;request&nbsp;</span><span style="background-color: #f5f5f5; color: #008000"><br></span><span style="background-color: #f5f5f5; color: #000000">&nbsp;&nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff">var</span><span style="background-color: #f5f5f5; color: #000000">&nbsp;instructions</span><span style="background-color: #f5f5f5; color: #000000">=</span><span style="background-color: #f5f5f5; color: #000000">{instruction:input.value};&nbsp;<br>&nbsp;&nbsp;worker.port.postMessage(instructions);&nbsp;<br>&nbsp;&nbsp;}&nbsp;<br>&nbsp;</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">script</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;/</span><span style="color: #800000">head</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">body&nbsp;</span><span style="color: #ff0000">onload</span><span style="color: #0000ff">=''</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">output&nbsp;</span><span style="color: #ff0000">id</span><span style="color: #0000ff">='response_from_worker'</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;&nbsp; Shared&nbsp;worker&nbsp;example:&nbsp;how&nbsp;to&nbsp;use&nbsp;shared&nbsp;worker&nbsp;in&nbsp;HTML5&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;/</span><span style="color: #800000">output</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp; send&nbsp;instructions&nbsp;to&nbsp;shared&nbsp;worker:&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;</span><span style="color: #800000">input&nbsp;</span><span style="color: #ff0000">type</span><span style="color: #0000ff">="text"</span><span style="color: #ff0000">&nbsp;autofocus&nbsp;oninput</span><span style="color: #0000ff">="postMessageToSharedWorker(this);return&nbsp;false;"</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;/</span><span style="color: #800000">input</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;/</span><span style="color: #800000">body</span><span style="color: #0000ff">&gt;</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">&lt;/</span><span style="color: #800000">html</span><span style="color: #0000ff">&gt;</span>&nbsp;</div><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>脚本文件代码：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<div><span style="color: #008000">&nbsp;//</span><span style="color: #008000">&nbsp;创建一个共享线程用于接收从不同连接发送过来的指令，指令处理完成后将结果返回到各个不同的连接用户。</span><span style="color: #008000"><br></span>&nbsp;<span style="color: #0000ff">var</span>&nbsp;connect_number&nbsp;=&nbsp;0;&nbsp;<br>&nbsp;<br>&nbsp;onconnect&nbsp;=&nbsp;<span style="color: #0000ff">function</span>(e)&nbsp;{&nbsp;<br>&nbsp;&nbsp;connect_number&nbsp;=connect_number+&nbsp;1;&nbsp;<br>&nbsp;&nbsp;<span style="color: #008000">//</span><span style="color: #008000">get&nbsp;the&nbsp;first&nbsp;port&nbsp;here&nbsp;</span><span style="color: #008000"><br></span>&nbsp;&nbsp;<span style="color: #0000ff">var</span>&nbsp;port&nbsp;=&nbsp;e.ports[0];&nbsp;<br>&nbsp;&nbsp;port.postMessage('A&nbsp;new&nbsp;connection!&nbsp;The&nbsp;current&nbsp;connection&nbsp;number&nbsp;is&nbsp;'&nbsp;<br>&nbsp;&nbsp;+&nbsp;connect_number);&nbsp;<br>&nbsp;&nbsp;port.onmessage&nbsp;=&nbsp;<span style="color: #0000ff">function</span>(e)&nbsp;{&nbsp;<br>&nbsp;&nbsp; <span style="color: #008000">//</span><span style="color: #008000">get&nbsp;instructions&nbsp;from&nbsp;requester&nbsp;</span><span style="color: #008000"><br></span>&nbsp;&nbsp; <span style="color: #0000ff">var</span>&nbsp;instruction=e.data.instruction;&nbsp;<br>&nbsp;&nbsp; <span style="color: #0000ff">var</span>&nbsp;results=execute_instruction(instruction);&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;port.postMessage('Request:&nbsp;'+instruction+'&nbsp;Response&nbsp;'+results&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +'&nbsp;from&nbsp;shared&nbsp;worker...');&nbsp;<br>&nbsp;&nbsp;};&nbsp;<br>&nbsp;};&nbsp;<br>&nbsp;<br>&nbsp;<span style="color: #008000">/*</span><span style="color: #008000">&nbsp;<br>&nbsp;*&nbsp;this&nbsp;function&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;execute&nbsp;the&nbsp;instructions&nbsp;send&nbsp;from&nbsp;requester&nbsp;<br>&nbsp;*&nbsp;@param&nbsp;instruction&nbsp;<br>&nbsp;*&nbsp;@return&nbsp;<br>&nbsp;</span><span style="color: #008000">*/</span>&nbsp;<br>&nbsp;<span style="color: #0000ff">function</span>&nbsp;execute_instruction(instruction)&nbsp;<br>&nbsp;{&nbsp;<br>&nbsp;<span style="color: #0000ff">var</span>&nbsp;result_value;&nbsp;<br>&nbsp;<span style="color: #008000">//</span><span style="color: #008000">implement&nbsp;your&nbsp;logic&nbsp;here&nbsp;</span><span style="color: #008000"><br></span>&nbsp;<span style="color: #008000">//</span><span style="color: #008000">execute&nbsp;the&nbsp;instruction...&nbsp;</span><span style="color: #008000"><br></span>&nbsp;<span style="color: #0000ff">return</span>&nbsp;result_value；<br>&nbsp;}&nbsp;</div><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在上面的共享线程例子中，在主页面即各个用户连接页面构造出一个共享线程对象，然后定义了一个方法 postMessageToSharedWorker 向共享线程发送来之用户的指令。同时，在共享线程的实现代码片段中定义 connect_number 用来记录连接到这个共享线程的总数。之后，用 onconnect 事件处理器接受来自不同用户的连接，解析它们传递过来的指令。最后，定义一个了方法 execute_instruction 用于执行用户的指令，指令执行完成后将结果返回给各个用户。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这里我们并没有跟前面的例子一样使用到了工作线程的 onmessage 事件处理器，而是使用了另外一种方式 addEventListener。实际上，前面已经说过，这两种的实现原理基本一致，只是在这里有些稍微的差别，如果使用到了 addEventListener 来接受来自共享线程的消息，那么就要先使用 worker.port.start() 方法来启动这个端口。之后就可以像工作线程的使用方式一样正常的接收和发送消息。</p>
<p>&nbsp;</p>
<p><strong style="color: #0000ff">最后陈述</strong></p>
<p><strong>线程中能做的事</strong>：<br>1.能使用setTimeout(), clearTimeout(), setInterval(),clearInterval()等函数。<br>2.能使用navigator对象。<br>3.能使用XMLHttpRequest来发送请求。<br>4.可以在线程中使用Web Storage。</p>
<p>5.线程中可以用self获取本线程的作用域。</p>
<p>&nbsp;</p>
<p><strong>线程中不能做的事</strong>：<br>1.线程中是不能使用除navigator外的DOM/BOM对象，例如window,document（想要操作的话只能发送消息给worker创建者，通过回调函数操作）。<br>2.线程中不能使用主线程中的变量和函数。<br>3.线程中不能使用有"挂起"效果的操作命令，例如alert等。<br>4.线程中不能跨域加载JS。</p>
<p>&nbsp;</p>
<p><strong style="color: #008000">线程也是需要消耗资源的，而且使用线程也会带来一定的复杂性，所以如果没有充足的理由来使用额外的线程的话，那么就不要用它。</strong></p>
<p><br><strong style="color: #0000ff">实用参考</strong><strong><br></strong>官方文档：<a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html">http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html</a><br>WebWorker分类说明：<a href="http://www.w3schools.com/html5/html5_webworkers.asp">http://www.w3schools.com/html5/html5_webworkers.asp</a><br>WebWorker概述：<a href="https://developer.mozilla.org/en/Using_web_workers">https://developer.mozilla.org/en/Using_web_workers</a></p></div><div id="MySignature"></div>



</div>

	</div>